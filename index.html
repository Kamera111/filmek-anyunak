<!doctype html>
<html lang="hu">
<head>
  <!-- ===== [SZAKASZ 1] HEAD + ST√çLUSOK ‚Äì START ===== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Filmek Anyunak</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --txt:#e5e7eb; --accent:#22d3ee; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .sticky{position:sticky;top:0;background:linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.75) 60%, rgba(15,23,42,0));backdrop-filter: blur(6px);z-index:10}
    header{display:flex;align-items:center;gap:12px;padding:12px 0}
    .title{font-weight:800;font-size:20px;letter-spacing:.3px}
    .btn{background:#1f2937;color:#fff;border:1px solid #334155;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn[hidden]{display:none!important}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px}
    .muted{color:var(--muted);font-size:14px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
    label{font-size:13px;color:#b3c1d1;margin-bottom:6px;display:block}
    form .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    img{max-width:100%;border-radius:10px;border:1px solid #1f2937}
    a{color:#a5f3fc;text-decoration:none}
    a:hover{text-decoration:underline}
    .catbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 18px}
    .pill{background:#0b1220;border:1px solid #334155;border-radius:999px;padding:8px 12px}
    .hidden{display:none!important}
    .pinBox,.loginBox{max-width:420px;margin:12vh auto;padding:18px}
    .pinInput{font-size:28px;letter-spacing:6px;text-align:center}
    .hint{font-size:12px;color:#9aa8b8}
    .movie a.title{font-weight:700;display:block;margin:6px 0}
    .del{border:1px dashed #ef4444;background:transparent;color:#ef4444}
    .footer{margin:30px 0 10px;text-align:center;color:#6b7280;font-size:12px}
  </style>
  <!-- ===== [SZAKASZ 1] HEAD + ST√çLUSOK ‚Äì END ===== -->
</head>
<body>
  <div class="wrap">
    <div class="sticky">
      <header>
        <div class="title">Filmek Anyunak</div>
        <div style="flex:1"></div>
        <button id="btnAddGlobal" class="btn hidden">+ √öj film</button>
        <button id="btnAdminLogout" class="btn hidden">Kijelentkez√©s</button>
      </header>
    </div>

    <!-- Vend√©g bel√©p≈ë -->
    <div id="pinView" class="card pinBox">
      <h2>Bel√©p√©s vend√©gk√©nt</h2>
      <p class="muted">
        A vend√©g bel√©p√©s a <b>guest@filmek-anyunak.app</b> / <b>195400</b> p√°rossal t√∂rt√©nik.
      </p>
      <label for="guestPin">Vend√©g PIN (csak l√°tv√°ny, automatikus a bel√©p√©s)</label>
      <input id="guestPin" class="pinInput" type="text" inputmode="numeric" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div style="height:10px"></div>
      <button id="btnGuestEnter" class="btn">Bel√©p√©s vend√©gk√©nt</button>
      <p class="hint">Vend√©gk√©nt csak olvasni tudsz. Felt√∂lt√©shez jelentkezz be adminnal.</p>
    </div>

    <!-- Admin bejelentkez√©s -->
    <div class="card loginBox">
      <h2>Admin bel√©p√©s</h2>
      <form id="adminLoginForm">
        <label for="adminEmail">Admin email</label>
        <input id="adminEmail" type="email" placeholder="chisnyan@gmail.com" required />
        <label for="adminPass">Admin jelsz√≥</label>
        <input id="adminPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
        <div style="height:10px"></div>
        <button class="btn" type="submit">Bel√©p√©s admink√©nt</button>
      </form>
    </div>

    <!-- App n√©zet (bejelentkez√©s ut√°n) -->
    <div id="app" class="card hidden">
      <h2>Filmlist√°k</h2>
      <div id="catBar" class="catbar"></div>
      <div id="lists" class="grid"></div>

      <!-- Admin panel: √∫j film hozz√°ad√°s -->
      <div id="adminPanel" class="card hidden" style="margin-top:16px">
        <h3>√öj film hozz√°ad√°sa</h3>
        <form id="addMovieForm">
          <div class="row">
            <div>
              <label for="catSelect">Kateg√≥ria</label>
              <select id="catSelect" name="cat" required></select>
            </div>
            <div>
              <label for="title">C√≠m</label>
              <input id="title" name="title" placeholder="Film c√≠me" required />
            </div>
          </div>
          <label for="url">Link</label>
          <input id="url" name="url" type="url" placeholder="https://‚Ä¶" required />
          <label for="cover">Bor√≠t√≥k√©p URL (opcion√°lis)</label>
          <input id="cover" name="cover" type="url" placeholder="https://‚Ä¶" />
          <label for="desc">Le√≠r√°s (opcion√°lis)</label>
          <textarea id="desc" name="desc" rows="3" placeholder="R√∂vid le√≠r√°s‚Ä¶"></textarea>
          <div style="height:10px"></div>
          <button class="btn" type="submit">Hozz√°ad√°s</button>
        </form>
      </div>
    </div>

    <div class="footer">¬© FilmeK Anyunak</div>
  </div>

  <!-- ===== [SZAKASZ 2] FIREBASE INIT (EGYS√âGES 10.12.4) ‚Äì START ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
    import {
      getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot,
      serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBDSI-z3a4IFAIoKCVZVcUyue7GMoO5acY",
      authDomain: "filmek-fe035.firebaseapp.com",
      projectId: "filmek-fe035",
      storageBucket: "filmek-fe035.appspot.com",
      messagingSenderId: "302167835367",
      appId: "1:302167835367:web:6e0fd4304c4496612c1842",
      measurementId: "G-QBG7LG0ZQH"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) { /* analytics nem k√∂telez≈ë */ }

    const db = getFirestore(app);
    const auth = getAuth(app);

    // Glob√°lis el√©r√©s a t√∂bbi szakasznak
    window.fb = {
      app, auth, db,
      fs: { collection, addDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy }
    };

    // Debug
    console.log("[FB] apiKey:", firebaseConfig.apiKey.slice(0,12));
    console.log("[FB] storageBucket:", firebaseConfig.storageBucket);
  </script>
  <!-- ===== [SZAKASZ 2] FIREBASE INIT ‚Äì END ===== -->

  <!-- ===== [SZAKASZ 3] KATEG√ìRI√ÅK + ALAP UI ‚Äì START ===== -->
  <script type="module">
    const CATEGORIES = [
      { key: 'akcio',     name: 'Akci√≥' },
      { key: 'thriller',  name: 'Thriller' },
      { key: 'krimi',     name: 'Krimi' },
      { key: 'vigjatek',  name: 'V√≠gj√°t√©k' },
      { key: 'szineszek', name: 'Sz√≠n√©szek' }
    ];
    const catBar   = document.getElementById('catBar');
    const lists    = document.getElementById('lists');
    const catSelect= document.getElementById('catSelect');

    catBar.innerHTML   = CATEGORIES.map(c => `<button class="pill" data-cat="${c.key}">${c.name}</button>`).join('');
    lists.innerHTML    = CATEGORIES.map(c => `<div class="card"><h3>${c.name}</h3><div data-cat-list="${c.key}"></div></div>`).join('');
    catSelect.innerHTML= CATEGORIES.map(c => `<option value="${c.key}">${c.name}</option>`).join('');

    catBar.addEventListener('click', e=>{
      const btn=e.target.closest('[data-cat]'); if(!btn) return;
      document.querySelector(`[data-cat-list="${btn.dataset.cat}"]`)?.parentElement.scrollIntoView({behavior:"smooth"});
    });
  </script>
  <!-- ===== [SZAKASZ 3] KATEG√ìRI√ÅK ‚Äì END ===== -->

  <!-- ===== [SZAKASZ 4] AUTH (VEND√âG / ADMIN) ‚Äì START ===== -->
  <script type="module">
    import { onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const { auth } = window.fb;

    const pinView      = document.getElementById('pinView');
    const appView      = document.getElementById('app');
    const guestPin     = document.getElementById('guestPin');
    const btnGuest     = document.getElementById('btnGuestEnter');
    const adminForm    = document.getElementById('adminLoginForm');
    const adminEmailEl = document.getElementById('adminEmail');
    const adminPassEl  = document.getElementById('adminPass');
    const btnLogout    = document.getElementById('btnAdminLogout');
    const btnAdd       = document.getElementById('btnAddGlobal');
    const adminPanel   = document.getElementById('adminPanel');

    async function guestLoginFixed(){
      try{
        await signInWithEmailAndPassword(auth,"guest@filmek-anyunak.app","195400");
      }catch(e){
        alert("Vend√©g bel√©p√©si hiba: "+e.message);
      }
    }
    btnGuest.addEventListener('click',e=>{e.preventDefault();guestLoginFixed();});
    guestPin.addEventListener('input',()=>{ if(guestPin.value.replace(/\D/g,'').length>=6) guestLoginFixed(); });

    adminForm.addEventListener('submit',async e=>{
      e.preventDefault();
      try{
        await signInWithEmailAndPassword(auth, adminEmailEl.value.trim(), adminPassEl.value);
      }catch(e){
        alert("Admin bel√©p√©si hiba: "+e.message);
      }
    });

    btnLogout.addEventListener('click', async ()=>{ await signOut(auth); });
    btnAdd.addEventListener('click', ()=> adminPanel.scrollIntoView({behavior:"smooth"}));

    onAuthStateChanged(auth, u=>{
      const logged = !!u;
      const isAdmin= logged && u.email==="chisnyan@gmail.com";

      pinView.classList.toggle('hidden', logged);
      appView.classList.toggle('hidden', !logged);
      btnLogout.classList.toggle('hidden', !logged);
      btnAdd.classList.toggle('hidden', !isAdmin);
      adminPanel.classList.toggle('hidden', !isAdmin);

      if (logged) window.startRealtime?.();
    });
  </script>
  <!-- ===== [SZAKASZ 4] AUTH ‚Äì END ===== -->

  <!-- ===== [SZAKASZ 5] FIRESTORE LIST√ÅZ√ÅS ‚Äì START ===== -->
  <script type="module">
    const { db, fs } = window.fb;

    function listenCategory(cat){
      const q = fs.query(
        fs.collection(db,`categories/${cat}/movies`),
        fs.orderBy("createdAt","desc")
      );
      return fs.onSnapshot(q, snap=>{
        const items=[]; snap.forEach(d=>items.push({id:d.id, ...d.data()}));
        renderCategory(cat, items);
      });
    }

    function renderCategory(cat, items){
      const w = document.querySelector(`[data-cat-list="${cat}"]`);
      if (!w) return;
      w.innerHTML = items.map(m=>`
        <div class="movie">
          <a class="title" href="${m.url}" target="_blank" rel="noopener">${m.title||'C√≠m n√©lk√ºl'}</a>
          ${m.cover?`<img src="${m.cover}" alt="">`:''}
          ${m.desc?`<div class="muted">${m.desc}</div>`:''}
          <button class="btn del btn-del hidden" data-cat="${cat}" data-id="${m.id}">üóë</button>
        </div>
      `).join('');

      const isAdmin = !!window.fb.auth.currentUser && window.fb.auth.currentUser.email==="chisnyan@gmail.com";
      w.querySelectorAll('.btn-del').forEach(b=>{
        b.classList.toggle('hidden', !isAdmin);
        b.onclick = async ()=>{
          await fs.deleteDoc(fs.doc(db,`categories/${b.dataset.cat}/movies/${b.dataset.id}`));
        };
      });
    }

    let unsub=[];
    window.startRealtime = ()=>{
      unsub.forEach(u=>u&&u());
      unsub = ["akcio","thriller","krimi","vigjatek","szineszek"].map(c=>listenCategory(c));
    };
  </script>
  <!-- ===== [SZAKASZ 5] FIRESTORE LIST√ÅZ√ÅS ‚Äì END ===== -->

  <!-- ===== [SZAKASZ 6] √öJ FILM HOZZ√ÅAD√ÅS ‚Äì START ===== -->
  <script type="module">
    const { db, fs } = window.fb;
    const form = document.getElementById('addMovieForm');

    form.addEventListener('submit', async e=>{
      e.preventDefault();
      const fd   = new FormData(form);
      const cat  = fd.get('cat');
      const title= (fd.get('title')||'').toString().trim();
      const url  = (fd.get('url')||'').toString().trim();
      const cover= (fd.get('cover')||'').toString().trim() || null;
      const desc = (fd.get('desc')||'').toString().trim() || null;

      if (!title || !url) { alert("C√≠m √©s link k√∂telez≈ë."); return; }

      try{
        await fs.addDoc(fs.collection(db,`categories/${cat}/movies`), {
          title, url, cover, desc, createdAt: fs.serverTimestamp()
        });
        form.reset();
        alert("Hozz√°adva.");
      }catch(e){
        alert("Hiba: "+e.message);
      }
    });
  </script>
  <!-- ===== [SZAKASZ 6] √öJ FILM HOZZ√ÅAD√ÅS ‚Äì END ===== -->

  <!-- ===== [SZAKASZ 7] FIRESTORE SECURITY RULES ‚Äì CSAK A FIREBASE CONSOLE-BA =====
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Olvasni csak bejelentkezve lehet:
    match /{doc=**} { allow read: if request.auth != null; }

    // √çrni/t√∂r√∂lni csak az admin emailr≈ël:
    match /categories/{cat}/movies/{doc} {
      allow create, update, delete: if request.auth != null
        && request.auth.token.email == "chisnyan@gmail.com";
    }
  }
}
  ===== [SZAKASZ 7] END ===== -->
</body>
</html>
