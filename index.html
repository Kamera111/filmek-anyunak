<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Filmek Anyunak</title>

  <!-- =========================
       1. rész – ALAP STÍLUSOK
  ========================== -->
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --txt:#e5e7eb; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .sticky{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(15,23,42,.98),rgba(15,23,42,.7) 60%,rgba(15,23,42,0));backdrop-filter:blur(6px)}
    header{display:flex;align-items:center;gap:12px;padding:10px 0}
    .title{font-weight:800;font-size:clamp(20px,4.6vw,28px)}
    .btn{background:#1f2937;color:#fff;border:1px solid #334155;border-radius:12px;padding:9px 13px;cursor:pointer;font-weight:600}
    .btn:active{transform:scale(.98)}
    .btn-danger{background:#dc2626;border-color:#b91c1c}
    .muted{color:var(--muted);font-size:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px}
    a{color:#a5f3fc;text-decoration:none} a:hover{text-decoration:underline}
    img{max-width:100%;border-radius:10px;border:1px solid #1f2937}

    /* felső színes kategória gombok */
    .top-filters{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;padding:6px 12px 12px}
    @media (max-width:900px){.top-filters{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.top-filters{grid-template-columns:1fr}}
    .chip{display:flex;flex-direction:column;gap:4px;padding:12px 14px;border-radius:14px;color:#fff;border:1px solid rgba(255,255,255,.16);box-shadow:0 4px 14px rgba(0,0,0,.18);cursor:pointer;transition:.12s}
    .chip:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.22);filter:brightness(1.03)}
    .chip-title{font-weight:800}
    .chip-sub{font-size:14px;opacity:.95}
    .chip-krimi{background:linear-gradient(180deg,#16a34a,#15803d)}
    .chip-akcio{background:linear-gradient(180deg,#2563eb,#1e40af)}
    .chip-thriller{background:linear-gradient(180deg,#e11d48,#be123c)}
    .chip-actors{background:linear-gradient(180deg,#f59e0b,#b45309)}

    /* ÉLŐ kártyarács */
    #catBar{padding:12px}
    .cats-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .cat{display:flex;flex-direction:column;gap:6px;padding:14px 16px;border-radius:14px;background:#1f2937;color:#fff;border:1px solid #0f2437;box-shadow:0 4px 14px rgba(0,0,0,.18)}
    .cat .name{color:#22c55e;font-weight:700;font-size:18px}
    .cat .name .live{color:#ef4444;font-weight:900;margin-right:4px}
    .cat .now{font-size:15px}
    .btn-back{margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
  </style>
</head>

<!-- =========================
     2. rész – FIREBASE INIT (ÉLES) + window.fb
     (KÖZVETLENÜL a </head> után legyen)
========================== -->
<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, onSnapshot,
    query, where, orderBy, limit, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBDSI-z3a4IFAIoKCVZVcUyue7GMoO5acY",
    authDomain: "filmek-fe035.firebaseapp.com",
    projectId: "filmek-fe035",
    storageBucket: "filmek-fe035.appspot.com",
    messagingSenderId: "302167835367",
    appId: "1:302167835367:web:6e0fd4304c4496612c1842",
    measurementId: "G-QBG7LG0ZQH"
  };

  const app  = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  window.firebaseConfig = firebaseConfig;
  window.fb = Object.freeze({
    app,
    db: { db, collection, addDoc, getDocs, onSnapshot, query, where, orderBy, limit, serverTimestamp },
    auth: { auth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
  });

  console.debug("[Firebase] READY – project:", firebaseConfig.projectId);
</script>

<body>
<!-- =========================
     3. rész – UI: FEJLÉC + TOP KATEGÓRIÁK + ÉLŐ RÁCS + NÉZET
========================== -->
<div id="app" class="wrap">
  <div class="sticky">
    <header>
      <div class="title">Filmek Anyunak</div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="btnLogoutAll" class="btn btn-danger" title="Kijelentkezés és vissza">Kilépés mindenből</button>
        <button id="btnRefreshAll" class="btn">Frissítés</button>
      </div>
    </header>

    <div id="topFilters" class="top-filters">
      <button class="chip chip-krimi"    data-goto="krimi"><div class="chip-title">KRIMI</div><div class="chip-sub">Új:<span id="badge-new-krimi">0</span> · Összes:<span id="badge-all-krimi">0</span></div></button>
      <button class="chip chip-akcio"    data-goto="akcio"><div class="chip-title">AKCIÓ</div><div class="chip-sub">Új:<span id="badge-new-akcio">0</span> · Összes:<span id="badge-all-akcio">0</span></div></button>
      <button class="chip chip-thriller" data-goto="thriller"><div class="chip-title">THRILLER</div><div class="chip-sub">Új:<span id="badge-new-thriller">0</span> · Összes:<span id="badge-all-thriller">0</span></div></button>
      <button class="chip chip-actors"   data-goto="actors"><div class="chip-title">SZÍNÉSZEK</div><div class="chip-sub">20 név (hamarosan)</div></button>
    </div>

    <div id="catBar"><div class="cats-row" id="catsLive"></div></div>
  </div>

  <main id="view" class="view"></main>
</div>

<!-- =========================
     3.1 rész – KILÉPÉS: capture + tiszta reload
========================== -->
<script>
(function(){
  async function doLogout(){
    try{
      localStorage.removeItem("filmek_anyunak_guest_ok");
      localStorage.removeItem("filmek_anyunak_admin_ok");
      localStorage.removeItem("admin_email");
      sessionStorage.clear();
    }catch{}
    try{
      const a = window.fb?.auth?.auth;
      const so = window.fb?.auth?.signOut;
      if (a && typeof so === "function"){
        await Promise.race([ so(a), new Promise(r=>setTimeout(r,1200)) ]);
      }
    }catch{}
    const clean = location.origin + location.pathname;
    if (location.href !== clean) location.href = clean; else location.reload();
  }
  document.addEventListener("click",(e)=>{
    const b = e.target.closest("#btnLogoutAll,button");
    if (!b) return;
    const t = (b.textContent||"") + " " + (b.title||"") + " " + (b.getAttribute?.("aria-label")||"");
    if (!/(kilép|kijelent|logout|sign\s*out)/i.test(t)) return;
    e.preventDefault(); e.stopPropagation();
    doLogout();
  }, true);
})();
</script>

<!-- =========================
     5. rész – ÉLŐ gombok feltöltése
========================== -->
<script>
(function(){
  const list = [
    {name:"ÉLŐ Vígjáték TV", url:"https://sweet.tv/hu/free_tv/2014-comedy-universe-hd", provider:"sweet"},
    {name:"ÉLŐ Akció TV",    url:"https://sweet.tv/hu/free_tv/2010-action-zone-hd",     provider:"sweet"},
    {name:"ÉLŐ Thriller TV", url:"https://sweet.tv/hu/free_tv/2016-thriller-time-hd",    provider:"sweet"},
    {name:"ÉLŐ TOP Filmek",  url:"https://sweet.tv/hu/free_tv/2967-top-movies-hd",       provider:"sweet"},
    {name:"Mozi+ tv",      url:"https://player.telekomtvgo.hu/player/live?channelNumber=13"},
    {name:"Film + tv",     url:"https://player.telekomtvgo.hu/player/live?channelNumber=15"},
    {name:"Prime tv",      url:"https://player.telekomtvgo.hu/player/live?channelNumber=21"},
    {name:"RTL 2 tv",      url:"https://player.telekomtvgo.hu/player/live?channelNumber=24"},
    {name:"FilmCafe tv",   url:"https://player.telekomtvgo.hu/player/live?channelNumber=28"},
    {name:"ozone tv",      url:"https://player.telekomtvgo.hu/player/live?channelNumber=30"},
    {name:"Cool tv",       url:"https://player.telekomtvgo.hu/player/live?channelNumber=60"},
    {name:"AXN tv",        url:"https://player.telekomtvgo.hu/player/live?channelNumber=61"},
    {name:"AMC tv",        url:"https://player.telekomtvgo.hu/player/live?channelNumber=62"},
    {name:"Paramount tv",  url:"https://player.telekomtvgo.hu/player/live?channelNumber=66"},
    {name:"FilmMánia tv",  url:"https://player.telekomtvgo.hu/player/live?channelNumber=163"},
    {name:"Moziverzum tv", url:"https://player.telekomtvgo.hu/player/live?channelNumber=169"}
  ];
  const host = document.getElementById("catsLive");
  if (!host) return;
  for (const ch of list){
    const a = document.createElement("a");
    a.className="cat"; a.target="_blank"; a.rel="noopener"; a.href=ch.url;
    const safe = ch.name.replace(/^ÉLŐ(\s+)/, "<span class='live'>ÉLŐ</span>$1");
    a.innerHTML = `<div class="name">${safe}</div><div class="now"><span class="label">Most megy:</span> <span class="title">Kattints</span></div>`;
    host.appendChild(a);
  }
})();
</script>

<!-- =========================
     3.6 rész – FILMLISTA (Vendég: egyszeri lekérés; Admin: realtime)
========================== -->
<script>
(function(){
  const $ = (s,r=document)=>r.querySelector(s);

  function goHome(){
    $("#catBar").style.display = "";
    $("#view").innerHTML = "";
    window.scrollTo({top:0, behavior:"smooth"});
  }
  function renderCategory(catKey, label){
    $("#catBar").style.display = "none";
    $("#view").innerHTML = `
      <div class="card" style="margin:12px;">
        <button class="btn btn-danger btn-back" id="btnBackHome">Vissza a főoldalra</button>
        <h2 style="margin:4px 0 8px">${label}</h2>
        <div class="muted" style="margin-bottom:10px">Lista betöltése…</div>
        <div id="list-${catKey}" class="grid"></div>
      </div>`;
    $("#btnBackHome").addEventListener("click", goHome);
    attachLoader(catKey);
  }
  function renderActors(){
    $("#catBar").style.display = "none";
    $("#view").innerHTML = `
      <div class="card" style="margin:12px;">
        <button class="btn btn-danger btn-back" id="btnBackHome">Vissza a főoldalra</button>
        <h2 style="margin:4px 0 8px">Színészek</h2>
        <div class="muted">20 név – hamarosan.</div>
      </div>`;
    $("#btnBackHome").addEventListener("click", goHome);
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    $("#topFilters").addEventListener("click",(e)=>{
      const b = e.target.closest(".chip"); if(!b) return;
      const g = b.dataset.goto;
      if (g==="krimi")    renderCategory("krimi","KRIMI");
      if (g==="akcio")    renderCategory("akcio","AKCIÓ");
      if (g==="thriller") renderCategory("thriller","THRILLER");
      if (g==="actors")   renderActors();
    });
    $("#btnRefreshAll").addEventListener("click", ()=>{
      const list = document.querySelector('#view [id^="list-"]');
      if (!list) return;
      const catKey = list.id.replace(/^list-/,'');
      attachLoader(catKey, true);
    });
  });

  function cardHtml(m){
    const img = m.cover ? `<img src="${m.cover}" alt="">` : "";
    return `<div class="card">${img}<div style="font-weight:800;margin:6px 0">${m.title||"Cím nélkül"}</div><div class="muted" style="margin-bottom:8px">${m.content||""}</div><a class="btn" href="${m.link||"#"}" target="_blank" rel="noopener">Megnyitás</a></div>`;
  }
  function updateBadges(catKey, total){
    const t = document.getElementById(`badge-all-${catKey}`); if (t) t.textContent=String(total||0);
    const n = document.getElementById(`badge-new-${catKey}`); if (n) n.textContent="0";
  }

  async function attachLoader(catKey, force=false){
    const listEl = document.getElementById(`list-${catKey}`);
    if (!listEl) return;
    const fbd = window.fb?.db;
    if (!fbd){ listEl.innerHTML = `<div class="muted">Firebase nincs inicializálva.</div>`; return; }

    const { db, collection, getDocs, onSnapshot, query, orderBy, limit } = fbd;
    listEl.innerHTML = `<div class="muted">Lista betöltése…</div>`;
    try{
      // vendég: egyszeri lekérés
      const q = query(collection(db,"categories",catKey,"movies"), orderBy("createdAt","desc"), limit(200));
      const snap = await getDocs(q);
      const movies = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      if (!movies.length){
        listEl.innerHTML = `<div class="muted">Még nincs film ebben a kategóriában.</div>`;
        updateBadges(catKey, 0);
        return;
      }
      listEl.innerHTML = movies.map(cardHtml).join("");
      updateBadges(catKey, movies.length);
    }catch(e){
      listEl.innerHTML = `<div class="muted">Hiba: ${e?.message||e}</div>`;
    }
  }
})();
</script>

<!-- =========================
     9. rész – Favicon (404 elkerülés)
========================== -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text y='50%' x='50%' dominant-baseline='middle' text-anchor='middle' font-size='44'>🎬</text></svg>">

</body>
</html>
