<!doctype html>
<html lang="hu">
<head>
  <!-- ===== [SZAKASZ 1] HEAD + ST√çLUSOK ‚Äì START ===== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum=1" />
  <title>Filmek Anyunak</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --txt:#e5e7eb; --accent:#22d3ee; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .sticky{position:sticky;top:0;background:linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.75) 60%, rgba(15,23,42,0));backdrop-filter: blur(6px);z-index:10}
    header{display:flex;align-items:center;gap:12px;padding:12px 0}
    .title{font-weight:800;font-size:20px;letter-spacing:.3px}
    .btn{background:#1f2937;color:#fff;border:1px solid #334155;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn[hidden]{display:none!important}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px}
    .muted{color:var(--muted);font-size:14px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
    label{font-size:13px;color:#b3c1d1;margin-bottom:6px;display:block}
    form .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    img{max-width:100%;border-radius:10px;border:1px solid #1f2937}
    a{color:#a5f3fc;text-decoration:none}
    a:hover{text-decoration:underline}
    .catbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .pill{background:#0b1220;border:1px solid #334155;border-radius:999px;padding:8px 12px}
    .hidden{display:none!important}
    .pinBox,.loginBox{max-width:380px;margin:12vh auto;padding:18px}
    .pinInput{font-size:28px;letter-spacing:6px;text-align:center}
    .hint{font-size:12px;color:#9aa8b8}
    .movie a.title{font-weight:700;display:block;margin:6px 0}
    .del{border:1px dashed #ef4444;background:transparent;color:#ef4444}
    .footer{margin:30px 0 10px;text-align:center;color:#6b7280;font-size:12px}
  </style>
  <!-- ===== [SZAKASZ 1] HEAD + ST√çLUSOK ‚Äì END ===== -->
</head>
<body>

<!-- ===== [SZAKASZ 2] FIREBASE CONFIG ‚Äì START ===== -->
<script type="module">
  // Import√°ljuk a sz√ºks√©ges Firebase modulokat
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  // Firebase konfigur√°ci√≥
  const firebaseConfig = {
    apiKey: "AIzaSyBDSI-z3a4IFAIoKCVZVcUyue7GMoO5acY",
    authDomain: "filmek-fe035.firebaseapp.com",
    projectId: "filmek-fe035",
    storageBucket: "filmek-fe035.appspot.com",
    messagingSenderId: "302167835367",
    appId: "1:302167835367:web:6e0fd4304c4496612c1842",
    measurementId: "G-QBG7LG0ZQH"
  };

  // Firebase inicializ√°l√°sa
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);

  // Firestore √©s Auth inicializ√°l√°sa
  export const db = getFirestore(app);
  export const auth = getAuth(app);
</script>
<!-- ===== [SZAKASZ 2] FIREBASE CONFIG ‚Äì END ===== -->
  
<!-- ===== [SZAKASZ 3] AUTH + FIRESTORE ‚Äì START ===== -->
<script type="module">
  // A m√°r inicializ√°lt app lek√©r√©se (nem hozunk l√©tre √∫jat!)
  import { getApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy 
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  if (!getApps().length) {
    console.error("Firebase app m√©g nincs inicializ√°lva ‚Äì ellen≈ërizd a [SZAKASZ 2]-t!");
  }
  const app  = getApp();
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // Ezt haszn√°lja a t√∂bbi szakasz
  window.fb = {
    app, auth, db,
    fs: { collection, addDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy }
  };

  // Debug: fut√≥ config ellen≈ërz√©se (seg√≠t az apiKey hib√°t levad√°szni)
  try {
    // @ts-ignore ‚Äì a .options nem tipiz√°lt, de l√©tezik a fut√≥ p√©ld√°nyon
    const opts = app.options || {};
    console.log("[FB] apiKey:", opts.apiKey);
    console.log("[FB] authDomain:", opts.authDomain);
    console.log("[FB] storageBucket:", opts.storageBucket);
  } catch (e) {
    console.warn("Nem siker√ºlt kiolvasni az app.options-t:", e);
  }
</script>
<!-- ===== [SZAKASZ 3] AUTH + FIRESTORE ‚Äì END ===== -->

  <!-- ===== [SZAKASZ 4] KATEG√ìRI√ÅK + ALAP UI ‚Äì START ===== -->
  <script type="module">
    const CATEGORIES = [
      { key: 'akcio',     name: 'Akci√≥' },
      { key: 'thriller',  name: 'Thriller' },
      { key: 'krimi',     name: 'Krimi' },
      { key: 'vigjatek',  name: 'V√≠gj√°t√©k' },
      { key: 'szineszek', name: 'Sz√≠n√©szek' }
    ];
    const catBar = document.getElementById('catBar');
    const lists  = document.getElementById('lists');
    const catSelect = document.getElementById('catSelect');

    catBar.innerHTML = CATEGORIES.map(c => `<button class="pill" data-cat="${c.key}">${c.name}</button>`).join('');
    lists.innerHTML  = CATEGORIES.map(c => `<div class="card"><h3>${c.name}</h3><div data-cat-list="${c.key}"></div></div>`).join('');
    catSelect.innerHTML = CATEGORIES.map(c => `<option value="${c.key}">${c.name}</option>`).join('');
  </script>
  <!-- ===== [SZAKASZ 4] KATEG√ìRI√ÅK ‚Äì END ===== -->

  <!-- ===== [SZAKASZ 5] AUTH (VEND√âG FIX 195400 / ADMIN) ‚Äì START ===== -->
  <script type="module">
    import { onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const auth = window.fb.auth;
    const pinView=document.getElementById('pinView'), appView=document.getElementById('app');
    const guestPin=document.getElementById('guestPin'), btnGuest=document.getElementById('btnGuestEnter');
    const adminForm=document.getElementById('adminLoginForm');
    const btnLogout=document.getElementById('btnAdminLogout'), btnAdd=document.getElementById('btnAddGlobal');
    const adminPanel=document.getElementById('adminPanel');

    async function guestLoginFixed(){ 
      try{ await signInWithEmailAndPassword(auth,"guest@filmek-anyunak.app","195400"); }
      catch(e){ alert("Vend√©g bel√©p√©si hiba: "+e.message); }
    }
    btnGuest?.addEventListener('click',e=>{e.preventDefault();guestLoginFixed();});
    guestPin?.addEventListener('input',()=>{ if(guestPin.value.length===6) guestLoginFixed(); });

    adminForm?.addEventListener('submit',async e=>{
      e.preventDefault();
      try{ await signInWithEmailAndPassword(auth,adminEmail.value.trim(),adminPass.value); }
      catch(e){ alert("Hiba: "+e.message); }
    });
    btnLogout?.addEventListener('click',async()=>{await signOut(auth);});

    onAuthStateChanged(auth,u=>{
      const logged=!!u, isAdmin=logged&&u.email==="chisnyan@gmail.com";
      pinView.classList.toggle('hidden',logged);
      appView.classList.toggle('hidden',!logged);
      btnAdd.classList.toggle('hidden',!isAdmin);
      btnLogout.classList.toggle('hidden',!logged);
      adminPanel.classList.toggle('hidden',!isAdmin);
      if(logged) window.startRealtime?.();
    });
  </script>
  <!-- ===== [SZAKASZ 5] AUTH ‚Äì END ===== -->

  <!-- ===== [SZAKASZ 6] FIRESTORE LIST√ÅZ√ÅS ‚Äì START ===== -->
  <script type="module">
    const { db, fs } = window.fb;
    function listenCategory(cat){ 
      const q=fs.query(fs.collection(db,`categories/${cat}/movies`),fs.orderBy("createdAt","desc"));
      return fs.onSnapshot(q,snap=>{
        const items=[]; snap.forEach(d=>items.push({id:d.id,...d.data()})); renderCategory(cat,items);
      });
    }
    let unsub=[]; window.startRealtime=()=>{ unsub.forEach(u=>u&&u()); unsub=["akcio","thriller","krimi","vigjatek","szineszek"].map(c=>listenCategory(c)); };

    function renderCategory(cat,items){ 
      const w=document.querySelector(`[data-cat-list="${cat}"]`); if(!w)return;
      w.innerHTML=items.map(m=>`
        <div class="movie">
          <a class="title" href="${m.url}" target="_blank">${m.title||'C√≠m n√©lk√ºl'}</a>
          ${m.cover?`<img src="${m.cover}" alt="">`:''}
          ${m.desc?`<div class="muted">${m.desc}</div>`:''}
          <button class="btn del btn-del hidden" data-cat="${cat}" data-id="${m.id}">üóë</button>
        </div>`).join('');
      const isAdmin=!!window.fb.auth.currentUser&&window.fb.auth.currentUser.email==="chisnyan@gmail.com";
      w.querySelectorAll('.btn-del').forEach(b=>{b.classList.toggle('hidden',!isAdmin); b.onclick=async()=>{await fs.deleteDoc(fs.doc(db,`categories/${cat}/movies/${b.dataset.id}`));};});
    }
  </script>
  <!-- ===== [SZAKASZ 6] FIRESTORE LIST√ÅZ√ÅS ‚Äì END ===== -->

  <!-- ===== [SZAKASZ 7] √öJ FILM HOZZ√ÅAD√ÅS ‚Äì START ===== -->
  <script type="module">
    const { db, fs } = window.fb;
    const form=document.getElementById('addMovieForm');
    form?.addEventListener('submit',async e=>{
      e.preventDefault();
      const fd=new FormData(form);
      const cat=fd.get('cat'), title=fd.get('title'), url=fd.get('url'), cover=fd.get('cover')||null, desc=fd.get('desc')||null;
      try{ await fs.addDoc(fs.collection(db,`categories/${cat}/movies`),{title,url,cover,desc,createdAt:fs.serverTimestamp()}); form.reset(); alert("Hozz√°adva."); }
      catch(e){ alert("Hiba: "+e.message); }
    });
  </script>
  <!-- ===== [SZAKASZ 7] √öJ FILM HOZZ√ÅAD√ÅS ‚Äì END ===== -->

  <!-- ===== [SZAKASZ 8] UX EXTRA ‚Äì START ===== -->
  <script type="module">
    document.getElementById('catBar').addEventListener('click',e=>{
      const btn=e.target.closest('[data-cat]'); if(!btn)return;
      document.querySelector(`[data-cat-list="${btn.dataset.cat}"]`)?.parentElement.scrollIntoView({behavior:"smooth"});
    });
  </script>
  <!-- ===== [SZAKASZ 8] UX EXTRA ‚Äì END ===== -->

  <!-- ===== [SZAKASZ 9] FIRESTORE SECURITY RULES ‚Äì CSAK A FIREBASE CONSOLE-BA =====
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{doc=**} { allow read: if request.auth!=null; }
    match /categories/{cat}/movies/{doc} {
      allow create,update,delete: if request.auth!=null && request.auth.token.email=="chisnyan@gmail.com";
    }
  }
}
  ===== [SZAKASZ 9] END ===== -->

</body>
</html>
