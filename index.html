<!-- =========================
     1. rész eleje – HEAD + ALAP STÍLUSOK
========================== -->
<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Filmek Anyunak</title>

  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --txt:#e5e7eb; --accent:#22d3ee; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .sticky{position:sticky;top:0;background:linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.75) 60%, rgba(15,23,42,0));backdrop-filter: blur(6px);z-index:10}
    header{display:flex;align-items:center;gap:12px;padding:12px 0}
    .title{font-weight:800;font-size:clamp(20px,4.8vw,28px);letter-spacing:.3px}
    .btn{background:#1f2937;color:#fff;border:1px solid #334155;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn:active{transform:scale(.98)}
    .btn[hidden]{display:none!important}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px}
    .muted{color:var(--muted);font-size:14px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
    label{font-size:13px;color:#b3c1d1;margin-bottom:6px;display:block}
    form .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    img{max-width:100%;border-radius:10px;border:1px solid #1f2937}
    a{color:#a5f3fc;text-decoration:none}
    a:hover{text-decoration:underline}
    .hidden{display:none!important}
    .footer{margin:30px 0 10px;text-align:center;color:#6b7280;font-size:12px}
  </style>
</head>
<!-- =========================
     1. rész vége
========================== -->


<!-- =========================
     2. rész eleje – APP SHELL (fejléc, nagy gombok, listák, admin panel)
========================== -->
<body>
  <div class="wrap">
    <div class="sticky">
      <header>
        <div class="title">Filmek Anyunak</div>
        <div style="flex:1"></div>
        <button id="btnAddGlobal" class="btn hidden">+ Új film</button>
        <button id="btnAdminLogout" class="btn hidden">Kijelentkezés</button>
      </header>
    </div>

    <!-- App nézet (bejelentkezés után) -->
    <div id="app" class="card hidden">

      <!-- NAGY KATEGÓRIA-GOMBOK (csak a nagy, „kártya” gombok) -->
      <div class="catsFull" id="cats">
        <button class="cat block" data-cat="krimi">Krimi</button>
        <button class="cat block" data-cat="thriller">Thriller</button>
        <button class="cat block" data-cat="akcio">Akció</button>
        <button class="cat block" data-cat="elo_vigjatek">ÉLŐ vígjáték TV</button>
        <button class="cat block" data-cat="elo_thriller">ÉLŐ Thriller TV</button>
        <button class="cat block" data-cat="elo_akcio">ÉLŐ Akció TV</button>

        <!-- ÚJ: MOZI +TV – külső link, 3. sor bal oldala (a rács 3 oszlopos) -->
        <a class="cat block external"
           href="https://player.telekomtvgo.hu/player/live?channelNumber=13"
           target="_blank" rel="noopener noreferrer">MOZI +TV</a>
      </div>

      <!-- A kategóriákhoz tartozó film-listák kártyái -->
      <div id="lists" class="grid"></div>

      <!-- Admin panel: új film hozzáadás -->
      <div id="adminPanel" class="card hidden" style="margin-top:16px">
        <h3>Új film hozzáadása</h3>
        <form id="addMovieForm">
          <div class="row">
            <div>
              <label for="catSelect">Kategória</label>
              <select id="catSelect" name="cat" required></select>
            </div>
            <div>
              <label for="title">Cím</label>
              <input id="title" name="title" placeholder="Film címe" required />
            </div>
          </div>
          <label for="url">Link</label>
          <input id="url" name="url" type="url" placeholder="https://…" required />
          <label for="cover">Borítókép URL (opcionális)</label>
          <input id="cover" name="cover" type="url" placeholder="https://…" />
          <label for="desc">Leírás (opcionális)</label>
          <textarea id="desc" name="desc" rows="3" placeholder="Rövid leírás…"></textarea>
          <div style="height:10px"></div>
          <button class="btn" type="submit">Hozzáadás</button>
        </form>
      </div>
    </div>

    <div class="footer">© FilmeK Anyunak</div>
  </div>
<!-- =========================
     2. rész vége
========================== -->


<!-- ===== [SZAKASZ 3] FEJLÉC + KATEGÓRIÁK + NÉZETEK – START ===== -->
<div id="app" class="wrap">
  <div class="sticky">
    <header>
      <div class="title">Filmek Anyunak</div>
      <button class="btn" id="btnRefreshAll" style="margin-left:auto">Frissítés</button>
    </header>

    <!-- EGYETLEN gombsor (az alsó KÉT sor törölve) -->
    <div id="catBar">
      <div class="cats-row" id="catsLive"></div>
    </div>
  </div>

  <!-- Tartalom / lejátszó nézet (ha van, maradhat változatlanul) -->
  <main id="view" class="view"></main>
</div>
<!-- ===== [SZAKASZ 3] FEJLÉC + KATEGÓRIÁK + NÉZETEK – END ===== -->

<!-- ===== [SZAKASZ 4] STÍLUS – START ===== -->
<style>
  #catBar { padding: 12px; }
  .cats-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap: 12px; }
  .cat {
    display: flex; flex-direction: column; align-items: flex-start; justify-content: center;
    padding: 14px 16px; border-radius: 14px; background: #1f2937; color: #fff; cursor: pointer;
    box-shadow: 0 4px 14px rgba(0,0,0,.18); transition: transform .08s ease, box-shadow .12s ease;
    min-height: 84px; text-align: left;
  }
  .cat:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.22); }
  .cat .name { font-weight: 700; font-size: 18px; line-height: 1.2; margin-bottom: 6px; }
  .cat .now  { font-size: 14px; opacity: .9; }
  .cat .now .label { opacity:.75; margin-right:6px; }
  .cat.loading .now { opacity:.6 }
  .cat.error   .now { color: #fecaca; }   /* halvány piros hiba */
  .cat.ok      .now { color: #bbf7d0; }   /* halvány zöld siker */
</style>
<!-- ===== [SZAKASZ 4] STÍLUS – END ===== -->

<!-- ===== [SZAKASZ 5] „MOST MEGY” LOGIKA – START ===== -->
<script>
/**
 * Összefoglaló:
 * - Csatorna: { id, name, url, parser? }
 * - Gomb alatt: "Most megy: <cím>" automatikusan frissítve.
 * - Sweet.tv specifikus minták + általános fallback (title / og:title / og:description).
 * - CORS-barát olvasás: https://r.jina.ai/ + eredeti URL.
 * - Auto-frissítés: 5 perc, manuális: „Frissítés” gomb.
 */

const channels = [];

/* ========== [5.1] CSATORNÁK HOZZÁADÁSA – START ========== */
function addChannel({ id, name, url, parser }) {
  channels.push({ id, name, url, parser });
}

/* >>> A TE 4 CSATORNÁD <<< */
addChannel({
  id: "live-vigjatek",
  name: "ÉLŐ Vígjáték TV",
  url: "https://sweet.tv/hu/free_tv/2014-comedy-universe-hd",
  parser: sweetTvParser
});

addChannel({
  id: "live-akcio",
  name: "ÉLŐ Akció TV",
  url: "https://sweet.tv/hu/free_tv/2010-action-zone-hd",
  parser: sweetTvParser
});

addChannel({
  id: "live-thriller",
  name: "ÉLŐ Thriller TV",
  url: "https://sweet.tv/hu/free_tv/2016-thriller-time-hd",
  parser: sweetTvParser
});

addChannel({
  id: "live-top",
  name: "ÉLŐ TOP Filmek",
  url: "https://sweet.tv/hu/free_tv/2967-top-movies-hd",
  parser: sweetTvParser
});

/* >>> ELŐKÉSZÍTETT HELY TOVÁBBI 10 GOMBNAK <<< 
   Csak másold alá, és majd megadjuk a nevet+linket:
   addChannel({ id: "live-005", name: "ÚJ gomb 1", url: "https://...", parser: sweetTvParser });
   addChannel({ id: "live-006", name: "ÚJ gomb 2", url: "https://...", parser: sweetTvParser });
   ... stb. összesen még 10-ig.
*/
/* ========== [5.1] CSATORNÁK HOZZÁADÁSA – END ========== */

/* ========== [5.2] UI RAJZOLÁS + ESEMÉNYEK – START ========== */
const catsLiveEl = document.getElementById("catsLive");
const btnRefreshAll = document.getElementById("btnRefreshAll");
const REFRESH_MS = 5 * 60 * 1000; // 5 perc

function renderButtons() {
  catsLiveEl.innerHTML = "";
  for (const ch of channels) {
    const btn = document.createElement("button");
    btn.className = "cat";
    btn.dataset.channel = ch.id;
    btn.innerHTML = `
      <div class="name">${escapeHtml(ch.name)}</div>
      <div class="now"><span class="label">Most megy:</span><span class="title" id="now-${ch.id}">— frissítés...</span></div>
    `;
    btn.addEventListener("click", () => openChannel(ch));
    catsLiveEl.appendChild(btn);
  }
}

function openChannel(ch) {
  // Jelenleg új lapon nyitja; ha saját beágyazott lejátszót használsz, itt cseréljük.
  window.open(ch.url, "_blank");
}
/* ========== [5.2] UI RAJZOLÁS + ESEMÉNYEK – END ========== */

/* ========== [5.3] FRISSÍTÉS MECHANIKA – START ========== */
btnRefreshAll?.addEventListener("click", () => updateAll());
renderButtons();
updateAll(); // első frissítés
setInterval(updateAll, REFRESH_MS); // periódikus frissítés

async function updateAll() {
  for (const ch of channels) {
    await updateOne(ch);
  }
}

async function updateOne(ch) {
  const titleEl = document.getElementById(`now-${ch.id}`);
  const btnEl = document.querySelector(`.cat[data-channel="${ch.id}"]`);
  if (!titleEl || !btnEl) return;

  try {
    btnEl.classList.add("loading");
    btnEl.classList.remove("ok","error");
    titleEl.textContent = "— frissítés…";

    const nowTitle = await fetchNowTitle(ch);
    if (nowTitle) {
      titleEl.textContent = nowTitle.trim();
      btnEl.classList.add("ok");
    } else {
      titleEl.textContent = "— nem sikerült kiolvasni a címet";
      btnEl.classList.add("error");
    }
  } catch (e) {
    titleEl.textContent = "— hiba történt";
    btnEl.classList.add("error");
  } finally {
    btnEl.classList.remove("loading");
  }
}
/* ========== [5.3] FRISSÍTÉS MECHANIKA – END ========== */

/* ========== [5.4] TARTALOM LEKÉRÉS + PARSEREK – START ========== */
async function fetchNowTitle(ch) {
  // Egyedi parser előnyben
  if (typeof ch.parser === "function") {
    const t = await ch.parser(ch);
    if (t) return t;
  }
  // Általános fallback: <title> vagy og:title / og:description
  const text = await fetchRawHtml(ch.url);
  const tTitle = matchTitle(text);
  if (tTitle) return cleanTitle(tTitle);

  const tOgTitle = matchOg(text, 'og:title');
  if (tOgTitle) return cleanTitle(tOgTitle);

  const tOgDesc = matchOg(text, 'og:description');
  if (tOgDesc) return cleanTitle(tOgDesc);

  return null;
}

/* ---- Sweet.tv-specifikus parser ----
   Többféle minta:
   1) „Most megy” környéki szöveg
   2) JSON-részletek: "now" / "title"
   3) Egyéb jól látható címfragmensek
*/
async function sweetTvParser(ch) {
  const html = await fetchRawHtml(ch.url);

  // 1) „Most megy” blokk környékéről cím kiemelése
  const mostIdx = html.search(/Most\s*megy/i);
  if (mostIdx >= 0) {
    const slice = html.slice(Math.max(0, mostIdx - 1200), mostIdx + 2000);
    const inTags = slice.match(/>([^<>]{2,120})</g);
    if (inTags) {
      const candidates = inTags
        .map(s => s.replace(/[<>]/g, "").trim())
        .filter(s => s && !/^Most\s*megy/i.test(s) && s.length >= 2 && s.length <= 120);
      const best = pickBestCandidate(candidates);
      if (best) return cleanTitle(best);
    }
  }

  // 2) JSON: "now" ... "title": "..."
  const jsonNowTitle = matchJsonNowTitle(html);
  if (jsonNowTitle) return cleanTitle(jsonNowTitle);

  // 3) Egyéb meta: og:description
  const ogDesc = matchOg(html, 'og:description');
  if (ogDesc) return cleanTitle(ogDesc);

  // 4) Fallback: <title>
  const t = matchTitle(html);
  if (t) return cleanTitle(t);

  return null;
}

/* ---- Közös segédek ---- */
async function fetchRawHtml(url) {
  const proxied = url.startsWith("https://")
      ? `https://r.jina.ai/${url}`
      : `https://r.jina.ai/http://${url.replace(/^https?:\/\//,'')}`;
  const res = await fetch(proxied, { method: "GET" });
  if (!res.ok) return "";
  return await res.text();
}

function matchTitle(text) {
  const m = text.match(/<title[^>]*>([\s\S]*?)<\/title>/i);
  return m && m[1] ? m[1] : null;
}

function matchOg(text, prop) {
  const re = new RegExp(`property=["']${prop}["'][^>]*content=["']([^"']+)["']`, "i");
  const m = text.match(re);
  return m && m[1] ? m[1] : null;
}

function matchJsonNowTitle(text) {
  // lazább keresés: ..."now"...{..."title":"VALAMI"...}
  const re = /"now"[^{}]*\{[^{}]*"title"\s*:\s*"([^"]{2,120})"/i;
  const m = text.match(re);
  if (m && m[1]) return m[1];
  // alternatíva: current|program|epg kulcsszavak
  const re2 = /"(current|program|epg)"[^{}]*\{[^{}]*"title"\s*:\s*"([^"]{2,120})"/i;
  const m2 = text.match(re2);
  return (m2 && m2[2]) ? m2[2] : null;
}

function pickBestCandidate(list) {
  // kiszűrjük az általános, nem-filmcímnek tűnő darabokat
  const bad = /^(Sweet\.?TV|TV|Live|Új|HD|FullHD|Profil|Bejelentkezés|Regisztráció)$/i;
  const cleaned = list
    .map(s => s.replace(/\s+/g, " ").trim())
    .filter(s => s && !bad.test(s))
    .filter(s => !/Sweet\.?TV/i.test(s))
    .filter(s => !/^Most\s*megy/i.test(s));

  // válasszuk a leghosszabb épkézláb jelöltet
  cleaned.sort((a,b) => b.length - a.length);
  return cleaned[0] || null;
}

function cleanTitle(t) {
  return t
    .replace(/\s+\|\s*Sweet\.?TV.*$/i, "")
    .replace(/ - Sweet\.?TV.*$/i, "")
    .replace(/\s+\|\s*Live.*$/i, "")
    .replace(/\s+—\s+.*$/,"")
    .replace(/\s*\|\s*HD\s*$/i,"")
    .replace(/\s+/g," ")
    .trim();
}

function escapeHtml(str) {
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
/* ========== [5.4] TARTALOM LEKÉRÉS + PARSEREK – END ========== */
</script>
<!-- ===== [SZAKASZ 5] „MOST MEGY” LOGIKA – END ===== -->

<!-- =========================
     6. rész eleje – AUTH (vendég + admin)
========================== -->
<script type="module">
  import { onAuthStateChanged, signInWithEmailAndPassword, signOut }
    from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  const { auth } = window.fb;

  const pinView      = document.getElementById('pinView');
  const appView      = document.getElementById('app');
  const guestPin     = document.getElementById('guestPin');
  const btnShowAdmin = document.getElementById('btnShowAdmin');
  const adminForm    = document.getElementById('adminLoginForm');
  const btnLogout    = document.getElementById('btnAdminLogout');
  const btnAdd       = document.getElementById('btnAddGlobal');
  const adminPanel   = document.getElementById('adminPanel');
  const pinError     = document.getElementById('pinError');

  // Vendég beléptetés automatikusan 6 szám után
  async function guestLogin(){
    try {
      await signInWithEmailAndPassword(auth,"guest@filmek-anyunak.app","195400");
    } catch(e) {
      if(pinError){ pinError.textContent="Hibás PIN kód!"; pinError.style.display="block"; }
      if(guestPin){ guestPin.value=""; guestPin.focus(); }
    }
  }
  if (guestPin){
    guestPin.addEventListener('input',()=>{
      if(pinError) pinError.style.display="none";
      if(guestPin.value.replace(/\D/g,'').length===6) guestLogin();
    });
  }

  // Admin űrlap mutatás/elrejtés – mindig üres mezőkkel nyisson
  if (btnShowAdmin && adminForm){
    btnShowAdmin.addEventListener('click',()=>{
      adminForm.classList.toggle('show');
      if(adminForm.classList.contains('show')){
        const e=document.getElementById('adminEmail'), p=document.getElementById('adminPass');
        if(e) e.value=""; if(p) p.value=""; e?.focus();
      }
    });
  }

  // Admin belépés
  adminForm?.addEventListener('submit',async ev=>{
    ev.preventDefault();
    const email=document.getElementById('adminEmail').value.trim();
    const pass =document.getElementById('adminPass').value;
    try{ await signInWithEmailAndPassword(auth,email,pass); }
    catch(e){ alert("Hiba: "+(e?.message||e)); }
    finally{ const p=document.getElementById('adminPass'); if(p) p.value=""; }
  });

  // Kijelentkezés
  btnLogout?.addEventListener('click', async ()=>{ await signOut(auth); });

  // Auth állapot váltás
  onAuthStateChanged(auth,u=>{
    const logged=!!u;
    const isAdmin=logged && u.email==="chisnyan@gmail.com";
    pinView?.classList.toggle('hidden',logged);
    appView?.classList.toggle('hidden',!logged);
    btnLogout?.classList.toggle('hidden',!logged);
    btnAdd?.classList.toggle('hidden',!isAdmin);
    adminPanel?.classList.toggle('hidden',!isAdmin);
    if(logged && window.startRealtime) window.startRealtime();
  });
</script>
<!-- =========================
     6. rész vége
========================== -->


<!-- =========================
     7. rész eleje – BELÉPŐ (vendég PIN + admin gomb/űrlap)
========================== -->
<div id="pinView" class="wrap">
  <input
    id="guestPin"
    class="pinInput"
    type="text"
    inputmode="numeric"
    pattern="[0-9]*"
    maxlength="6"
    placeholder="Katt ide! Add a kódot!"
    aria-label="Vendég PIN"
    autocomplete="one-time-code"
  />
  <div id="pinError" role="alert" aria-live="polite" style="display:none;"></div>
  <button id="btnShowAdmin" type="button" title="Admin belépés">A</button>
  <form id="adminLoginForm" autocomplete="off">
    <input id="adminEmail" type="email" inputmode="email" placeholder="Admin email"
           autocomplete="off" autocapitalize="none" spellcheck="false" required />
    <input id="adminPass" type="password" placeholder="Jelszó"
           autocomplete="new-password" autocapitalize="none" spellcheck="false" required />
    <button type="submit">Admin belépés</button>
  </form>
</div>
<!-- =========================
     7. rész vége
========================== -->


<!-- =========================
     8. rész eleje – (Megjegyzés) FIRESTORE SECURITY RULES – csak a konzolba
========================== -->
<!--
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Olvasás csak bejelentkezve
    match /{doc=**} { allow read: if request.auth != null; }

    // Írás csak admin emailről
    match /categories/{cat}/movies/{doc} {
      allow create, update, delete: if request.auth != null
        && request.auth.token.email == "chisnyan@gmail.com";
    }
  }
}
-->
<!-- =========================
     8. rész vége
========================== -->

</body>
</html>
