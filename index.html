<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Filmek Anyunak</title>

  <!-- ========== 1. RÉSZ ELEJE – ALAP STÍLUSOK ========== -->
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --txt:#e5e7eb; --line:#233046; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .sticky{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(15,23,42,.98),rgba(15,23,42,.7) 60%,rgba(15,23,42,0));backdrop-filter:blur(6px)}
    header{display:flex;align-items:center;gap:12px;padding:10px 0}
    .title{font-weight:800;font-size:clamp(20px,4.6vw,28px)}
    .btn{background:#1f2937;color:#fff;border:1px solid #334155;border-radius:12px;padding:9px 13px;cursor:pointer;font-weight:600}
    .btn:active{transform:scale(.98)}
    .btn-danger{background:#dc2626;border-color:#b91c1c}
    .muted{color:var(--muted);font-size:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px}
    a{color:#a5f3fc;text-decoration:none} a:hover{text-decoration:underline}
    img{max-width:100%;border-radius:10px;border:1px solid #1f2937}

    /* felső színes kategória gombok */
    .top-filters{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;padding:6px 12px 12px}
    @media (max-width:900px){.top-filters{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.top-filters{grid-template-columns:1fr}}
    .chip{display:flex;flex-direction:column;gap:4px;padding:12px 14px;border-radius:14px;color:#fff;border:1px solid rgba(255,255,255,.16);box-shadow:0 4px 14px rgba(0,0,0,.18);cursor:pointer;transition:.12s}
    .chip:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.22);filter:brightness(1.03)}
    .chip-title{font-weight:800}
    .chip-sub{font-size:14px;opacity:.95}
    .chip-krimi{background:linear-gradient(180deg,#16a34a,#15803d)}
    .chip-akcio{background:linear-gradient(180deg,#2563eb,#1e40af)}
    .chip-thriller{background:linear-gradient(180deg,#e11d48,#be123c)}
    .chip-actors{background:linear-gradient(180deg,#f59e0b,#b45309)}

    /* ÉLŐ kártyarács */
    #catBar{padding:12px}
    .cats-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .cat{display:flex;flex-direction:column;gap:6px;padding:14px 16px;border-radius:14px;background:#1f2937;color:#fff;border:1px solid #0f2437;box-shadow:0 4px 14px rgba(0,0,0,.18)}
    .cat .name{color:#22c55e;font-weight:700;font-size:18px}
    .cat .name .live{color:#ef4444;font-weight:900;margin-right:4px}
    .cat .now{font-size:15px}
    .btn-back{margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}

    /* ===== Modálok (Admin, Vendég kapu) ===== */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;max-width:460px;width:100%;box-shadow:0 10px 35px rgba(0,0,0,.35)}
    .modal h3{margin:0 0 10px}
    .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
    .field input{background:#0b1220;color:#fff;border:1px solid #324156;border-radius:10px;padding:10px 12px;font-size:15px;outline:none}
    .row{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:10px}
    .hint{font-size:12px;color:var(--muted)}
    .err{color:#fecaca;font-size:13px;min-height:18px}
    .show{display:flex}

    /* Feltöltő űrlap */
    .uploader{display:grid;grid-template-columns:1fr;gap:10px;margin:10px 0 6px}
    .uploader .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:680px){ .uploader .two{grid-template-columns:1fr} }
    .preview{display:flex;gap:10px;align-items:flex-start}
    .preview img{width:120px;height:72px;object-fit:cover}
  </style>
  <!-- ========== 1. RÉSZ VÉGE – ALAP STÍLUSOK ========== -->
</head>

<!-- ========== 2. RÉSZ ELEJE – FIREBASE INIT (doc + deleteDoc hozzáadva!) ========== -->
<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, onSnapshot,
    query, where, orderBy, limit, serverTimestamp,
    doc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBDSI-z3a4IFAIoKCVZVcUyue7GMoO5acY",
    authDomain: "filmek-fe035.firebaseapp.com",
    projectId: "filmek-fe035",
    storageBucket: "filmek-fe035.appspot.com",
    messagingSenderId: "302167835367",
    appId: "1:302167835367:web:6e0fd4304c4496612c1842",
    measurementId: "G-QBG7LG0ZQH"
  };

  const app  = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  // Globális híd – most már doc + deleteDoc is bent van
  window.fb = {
    app,
    db: { db, collection, addDoc, getDocs, onSnapshot, query, where, orderBy, limit, serverTimestamp, doc, deleteDoc },
    auth: { auth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
  };
  console.debug("[Firebase] READY – project:", firebaseConfig.projectId);
</script>
<!-- ========== 2. RÉSZ VÉGE – FIREBASE INIT ========== -->

<body>
<!-- ========== 3. RÉSZ ELEJE – FŐ UI (HEADER + KATEGÓRIÁK) ========== -->
<div id="app" class="wrap">
  <div class="sticky">
    <header>
      <div class="title">Filmek Anyunak</div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="btnAdmin" class="btn" title="Admin belépés">A</button>
        <button id="btnRefreshAll" class="btn">Frissítés</button>
      </div>
    </header>

    <div id="topFilters" class="top-filters">
      <button class="chip chip-krimi"    data-goto="krimi"><div class="chip-title">KRIMI</div><div class="chip-sub">Új:<span id="badge-new-krimi">0</span> · Összes:<span id="badge-all-krimi">0</span></div></button>
      <button class="chip chip-akcio"    data-goto="akcio"><div class="chip-title">AKCIÓ</div><div class="chip-sub">Új:<span id="badge-new-akcio">0</span> · Összes:<span id="badge-all-akcio">0</span></div></button>
      <button class="chip chip-thriller" data-goto="thriller"><div class="chip-title">THRILLER</div><div class="chip-sub">Új:<span id="badge-new-thriller">0</span> · Összes:<span id="badge-all-thriller">0</span></div></button>
      <button class="chip chip-actors"   data-goto="actors"><div class="chip-title">SZÍNÉSZEK</div><div class="chip-sub">20 név (hamarosan)</div></button>
    </div>

    <div id="catBar"><div class="cats-row" id="catsLive"></div></div>
  </div>

  <main id="view" class="view"></main>
</div>
<!-- ========== 3. RÉSZ VÉGE – FŐ UI (HEADER + KATEGÓRIÁK) ========== -->

<!-- ========== 3.5. RÉSZ ELEJE – BADGE FRISSÍTŐ (Új/Összes) ========== -->
<script>
(function(){
  async function refreshBadges(){
    try{
      const fbd = window.fb?.db; if (!fbd) return;
      const { db, collection, getDocs, query, orderBy, limit } = fbd;
      const cats = ["krimi","akcio","thriller"];
      for (const k of cats){
        // egyszerű darabszám: legfeljebb 1000-ig számolunk (nekünk most elég)
        const q = query(collection(db,"categories",k,"movies"), orderBy("createdAt","desc"), limit(1000));
        const snap = await getDocs(q);
        const total = snap.size || 0;
        const t = document.getElementById(`badge-all-${k}`); if (t) t.textContent = String(total);
        const n = document.getElementById(`badge-new-${k}`); if (n) n.textContent = "0";
      }
    }catch(e){ console.warn("Badge frissítés hiba:", e); }
  }
  document.addEventListener("DOMContentLoaded", refreshBadges);
  document.addEventListener("admin:login", refreshBadges);
  document.addEventListener("admin:logout", refreshBadges);
  document.getElementById("btnRefreshAll").addEventListener("click", refreshBadges);
})();
</script>
<!-- ========== 3.5. RÉSZ VÉGE – BADGE FRISSÍTŐ ========== -->

<!-- ========== 4. RÉSZ ELEJE – MODÁLOK (Admin belépő + Vendég kapu) ========== -->
<!-- Admin belépő -->
<div id="adminModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="admintitle">
    <h3 id="admintitle">Admin belépés</h3>
    <div class="field">
      <label for="admEmail">Email</label>
      <input id="admEmail" type="email" inputmode="email" autocomplete="username" placeholder="pl. te@pelda.hu">
    </div>
    <div class="field">
      <label for="admPass">Jelszó</label>
      <input id="admPass" type="password" autocomplete="current-password" placeholder="••••••••">
      <div class="hint">A jelszó nincs előtöltve — kézzel írd be.</div>
    </div>
    <div class="err" id="admErr"></div>
    <div class="row">
      <button id="admCancel" class="btn btn-danger" type="button">Mégse</button>
      <button id="admSubmit" class="btn" type="button">Belépés</button>
    </div>
  </div>
</div>

<!-- Vendég kapu -->
<div id="guestModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="guesttitle">
    <h3 id="guesttitle">Vendég kapu</h3>
    <div class="field">
      <label for="guestPin">PIN (6 számjegy)</label>
      <input id="guestPin" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="pl. 195400">
      <div class="hint">Helyes PIN: 195400</div>
    </div>
    <div class="err" id="guestErr"></div>
    <div class="row">
      <button id="guestCancel" class="btn btn-danger" type="button">Mégse</button>
      <button id="guestSubmit" class="btn" type="button">Belépés vendégként</button>
    </div>
  </div>
</div>
<!-- ========== 4. RÉSZ VÉGE – MODÁLOK ========== -->

<!-- ========== 5. RÉSZ ELEJE – ADMIN / VENDÉG VEZÉRLÉS (gombok, kapu, kilépés) ========== -->
<script>
(function(){
  const LS_ADMIN_OK     = "filmek_anyunak_admin_ok";
  const LS_ADMIN_EMAIL  = "admin_email";
  const LS_GUEST_OK     = "filmek_anyunak_guest_ok";
  const GUEST_PIN       = "195400";

  const btn     = document.getElementById("btnAdmin");
  const admM    = document.getElementById("adminModal");
  const admEmail= document.getElementById("admEmail");
  const admPass = document.getElementById("admPass");
  const admErr  = document.getElementById("admErr");
  const admCancel=document.getElementById("admCancel");
  const admSubmit=document.getElementById("admSubmit");

  const gusM    = document.getElementById("guestModal");
  const gusPin  = document.getElementById("guestPin");
  const gusErr  = document.getElementById("guestErr");
  const gusCancel=document.getElementById("guestCancel");
  const gusSubmit=document.getElementById("guestSubmit");

  function openModal(m){ m.classList.add("show"); m.setAttribute("aria-hidden","false"); }
  function closeModal(m){ m.classList.remove("show"); m.setAttribute("aria-hidden","true"); }

  function loggedIn(){
    try{
      if (window.fb?.auth?.auth?.currentUser) return true;
      return localStorage.getItem(LS_ADMIN_OK)==="1";
    }catch{return false;}
  }
  function guestOk(){ try{ return localStorage.getItem(LS_GUEST_OK)==="1"; }catch{return false;} }

  function ensureGuestGate(){
    if (loggedIn()) return;
    if (guestOk()) return;
    gusErr.textContent=""; gusPin.value="";
    openModal(gusM); setTimeout(()=>gusPin.focus(),0);
  }

  function setAdminUi(){
    btn.textContent = loggedIn() ? "Admin kilépés" : "A";
    btn.title = loggedIn() ? "Kijelentkezés és vissza a vendég kapuba" : "Admin belépés";
  }

  async function doLogin(){
    admErr.textContent="";
    const email = String(admEmail.value||"").trim();
    const pass  = String(admPass.value||"");
    if(!email || !pass){ admErr.textContent="Add meg az email címet és a jelszót."; return; }
    try{
      const a  = window.fb?.auth?.auth;
      const si = window.fb?.auth?.signInWithEmailAndPassword;
      if (!a || typeof si!=="function") throw new Error("Firebase Auth nincs inicializálva.");
      await Promise.race([ si(a,email,pass), new Promise((_,rej)=>setTimeout(()=>rej(new Error("Időtúllépés")),8000)) ]);
      localStorage.setItem(LS_ADMIN_OK,"1");
      localStorage.setItem(LS_ADMIN_EMAIL,email);
      closeModal(admM);
      setAdminUi();
      document.dispatchEvent(new CustomEvent("admin:login"));
    }catch(e){ admErr.textContent = e?.message || "Ismeretlen hiba."; }
  }

  async function doLogoutToGuestGate(){
    try{
      localStorage.removeItem(LS_ADMIN_OK);
      sessionStorage.clear();
    }catch{}
    try{
      const a = window.fb?.auth?.auth;
      const so = window.fb?.auth?.signOut;
      if (a && typeof so==="function"){
        await Promise.race([ so(a), new Promise(r=>setTimeout(r,1200)) ]);
      }
    }catch{}
    setAdminUi();
    document.dispatchEvent(new CustomEvent("admin:logout"));
    localStorage.removeItem(LS_GUEST_OK);
    ensureGuestGate();
  }

  btn.addEventListener("click", ()=> loggedIn() ? doLogoutToGuestGate() : (admErr.textContent="", admEmail.value=localStorage.getItem("admin_email")||"", admPass.value="", openModal(admM), setTimeout(()=> (admEmail.value?admPass:admEmail).focus(),0)));
  admCancel.addEventListener("click", ()=>closeModal(admM));
  admSubmit.addEventListener("click", doLogin);

  admM.addEventListener("click",(e)=>{ if(e.target===admM) closeModal(admM); });
  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape" && admM.classList.contains("show")) closeModal(admM);
    if(e.key==="Enter"  && admM.classList.contains("show")) doLogin();
  });

  function tryGuest(){
    gusErr.textContent="";
    const v = (gusPin.value||"").trim();
    if (v===GUEST_PIN){
      localStorage.setItem(LS_GUEST_OK,"1");
      closeModal(gusM);
    }else{
      gusErr.textContent="Hibás PIN.";
    }
  }
  gusSubmit.addEventListener("click", tryGuest);
  gusCancel.addEventListener("click", ()=>closeModal(gusM));
  gusM.addEventListener("click",(e)=>{ if(e.target===gusM) closeModal(gusM); });
  document.addEventListener("keydown",(e)=>{
    if(e.key==="Enter" && gusM.classList.contains("show")) tryGuest();
    if(e.key==="Escape"&& gusM.classList.contains("show")) closeModal(gusM);
  });

  try{
    const o = window.fb?.auth?.onAuthStateChanged;
    const a = window.fb?.auth?.auth;
    if (typeof o==="function" && a){
      o(a,(user)=>{
        if (user){
          localStorage.setItem(LS_ADMIN_OK,"1");
          if (user.email) localStorage.setItem("admin_email",user.email);
          document.dispatchEvent(new CustomEvent("admin:login"));
        }else{
          localStorage.removeItem(LS_ADMIN_OK);
          document.dispatchEvent(new CustomEvent("admin:logout"));
        }
        setAdminUi();
      });
    }
  }catch{}

  setAdminUi();
  document.addEventListener("DOMContentLoaded", ensureGuestGate, { once:true });
})();
</script>
<!-- ========== 5. RÉSZ VÉGE – ADMIN / VENDÉG VEZÉRLÉS ========== -->

<!-- ========== 6. RÉSZ ELEJE – ÉLŐ TV GOMBOK FELTÖLTÉSE ========== -->
<script>
(function(){
  const list = [
    {name:"ÉLŐ Vígjáték TV", url:"https://sweet.tv/hu/free_tv/2014-comedy-universe-hd", provider:"sweet"},
    {name:"ÉLŐ Akció TV",    url:"https://sweet.tv/hu/free_tv/2010-action-zone-hd",     provider:"sweet"},
    {name:"ÉLŐ Thriller TV", url:"https://sweet.tv/hu/free_tv/2016-thriller-time-hd",    provider:"sweet"},
    {name:"ÉLŐ TOP Filmek",  url:"https://sweet.tv/hu/free_tv/2967-top-movies-hd",       provider:"sweet"},
    {name:"Mozi+ tv",      url:"https://player.telekomtvgo.hu/player/live?channelNumber=13"},
    {name:"Film + tv",     url:"https://player.telekomtvgo.hu/player/live?channelNumber=15"},
    {name:"Prime tv",      url:"https://player.telekomtvgo.hu/player/live?channelNumber=21"},
    {name:"RTL 2 tv",      url:"https://player.telekomtvgo.hu/player/live?channelNumber=24"},
    {name:"FilmCafe tv",   url:"https://player.telekomtvgo.hu/player/live?channelNumber=28"},
    {name:"ozone tv",      url:"https://player.telekomtvgo.hu/player/live?channelNumber=30"},
    {name:"Cool tv",       url:"https://player.telekomtvgo.hu/player/live?channelNumber=60"},
    {name:"AXN tv",        url:"https://player.telekomtvgo.hu/player/live?channelNumber=61"},
    {name:"AMC tv",        url:"https://player.telekomtvgo.hu/player/live?channelNumber=62"},
    {name:"Paramount tv",  url:"https://player.telekomtvgo.hu/player/live?channelNumber=66"},
    {name:"FilmMánia tv",  url:"https://player.telekomtvgo.hu/player/live?channelNumber=163"},
    {name:"Moziverzum tv", url:"https://player.telekomtvgo.hu/player/live?channelNumber=169"}
  ];
  const host = document.getElementById("catsLive");
  if (!host) return;
  for (const ch of list){
    const a = document.createElement("a");
    a.className="cat"; a.target="_blank"; a.rel="noopener"; a.href=ch.url;
    const safe = ch.name.replace(/^ÉLŐ(\s+)/, "<span class='live'>ÉLŐ</span>$1");
    a.innerHTML = `<div class="name">${safe}</div><div class="now"><span class="label">Most megy:</span> <span class="title">Kattints</span></div>`;
    host.appendChild(a);
  }
})();
</script>
<!-- ========== 6. RÉSZ VÉGE – ÉLŐ TV GOMBOK FELTÖLTÉSE ========== -->

<!-- ========== 7. RÉSZ ELEJE – FILMLISTA + ADMIN FELTÖLTŐ + TÖRLÉS ========== -->
<script>
(function(){
  const $ = (s,r=document)=>r.querySelector(s);
  const LS_ADMIN_OK = "filmek_anyunak_admin_ok";

  function isAdmin(){
    try{
      if (window.fb?.auth?.auth?.currentUser) return true;
      return localStorage.getItem(LS_ADMIN_OK) === "1";
    }catch{ return false; }
  }

  function goHome(){
    $("#catBar").style.display = "";
    $("#view").innerHTML = "";
    window.scrollTo({top:0, behavior:"smooth"});
  }

  function cardHtml(m, catKey, admin){
    const img = m.cover ? `<img src="${m.cover}" alt="">` : "";
    const title = m.title || "Cím nélkül";
    const content = m.content || "";
    const link = m.link || "#";
    const delBtn = admin ? `<button class="btn btn-danger btn-del" data-id="${m.id}" data-cat="${catKey}">Törlés</button>` : "";
    return `<div class="card">${img}<div style="font-weight:800;margin:6px 0">${title}</div><div class="muted" style="margin-bottom:8px">${content}</div><div style="display:flex;gap:8px;flex-wrap:wrap"><a class="btn" href="${link}" target="_blank" rel="noopener">Megnyitás</a>${delBtn}</div></div>`;
  }

  function updateBadges(catKey, total){
    const t = document.getElementById(`badge-all-${catKey}`); if (t) t.textContent=String(total||0);
    const n = document.getElementById(`badge-new-${catKey}`); if (n) n.textContent="0";
  }

  async function fetchMeta(url){
    const u = String(url||"").trim();
    if (!u) return {};
    const tryJson = async (endpoint)=>{
      const r = await fetch(endpoint, { mode:"cors" });
      if (!r.ok) throw new Error("meta http");
      return await r.json();
    };
    try{
      if (/youtube\.com|youtu\.be/.test(u)){
        const o = await tryJson(`https://www.youtube.com/oembed?url=${encodeURIComponent(u)}&format=json`);
        return { title:o.title, cover:o.thumbnail_url };
      }
      if (/vimeo\.com/.test(u)){
        const o = await tryJson(`https://vimeo.com/api/oembed.json?url=${encodeURIComponent(u)}`);
        return { title:o.title, cover:o.thumbnail_url };
      }
      if (/dailymotion\.com/.test(u)){
        const o = await tryJson(`https://www.dailymotion.com/services/oembed?url=${encodeURIComponent(u)}`);
        return { title:o.title, cover:o.thumbnail_url };
      }
      if (/sweet\.tv/.test(u)){
        const p = new URL(u);
        const last = decodeURIComponent(p.pathname.split("/").filter(Boolean).pop()||"").replace(/[-_]/g," ");
        return { title: (last||"Sweet.tv film").replace(/\s+hd$/i,""), cover: "" };
      }
    }catch(e){}
    try{
      const p = new URL(u);
      const last = decodeURIComponent(p.pathname.split("/").filter(Boolean).pop()||"");
      const guess = last.replace(/[-_]/g," ").replace(/\.\w+$/,"");
      return { title: guess || p.hostname, cover:"" };
    }catch{ return {}; }
  }

  function uploaderHtml(catKey){
    return `
      <div class="card" style="margin:12px;">
        <h3 style="margin:0 0 8px">Új film hozzáadása – <span class="muted">${catKey.toUpperCase()}</span></h3>
        <div class="uploader">
          <div class="field">
            <label>Videó/film link</label>
            <input id="upLink" type="url" placeholder="Illeszd be a linket (YouTube, Sweet.tv, stb.)">
            <div class="hint">Beillesztés után a cím és a borítókép automatikusan kitöltődik (ha lehetséges).</div>
          </div>
          <div class="two">
            <div class="field"><label>Cím</label><input id="upTitle" type="text" placeholder="Automatikusan kitöltve"></div>
            <div class="field"><label>Borítókép (URL)</label><input id="upCover" type="url" placeholder="Automatikusan kitöltve (ha elérhető)"></div>
          </div>
          <div class="field"><label>Leírás (opcionális)</label><input id="upDesc" type="text" placeholder="Rövid megjegyzés…"></div>
          <div class="preview"><img id="upPrev" src="" alt="" style="display:none"><div class="muted">Előnézet</div></div>
          <div class="row">
            <button id="upCancel" class="btn btn-danger" type="button">Mégse</button>
            <button id="upSubmit" class="btn" type="button">Feltöltés</button>
          </div>
          <div class="err" id="upErr"></div>
        </div>
      </div>`;
  }

  function bindUploader(catKey, afterAdded){
    const $id = (x)=>document.getElementById(x);
    const link  = $id("upLink"), title=$id("upTitle"), cover=$id("upCover"), desc=$id("upDesc"), prev=$id("upPrev"), err=$id("upErr");
    function updatePrev(){ const u=(cover.value||"").trim(); prev.style.display=u?"block":"none"; prev.src=u||""; }
    cover.addEventListener("input", updatePrev);

    let typingTimer=null;
    link.addEventListener("input", ()=>{
      clearTimeout(typingTimer);
      typingTimer = setTimeout(async ()=>{
        err.textContent="";
        const meta = await fetchMeta(link.value);
        if (meta.title && !title.value) title.value = meta.title;
        if (meta.cover && !cover.value) { cover.value = meta.cover; updatePrev(); }
      }, 350);
    });

    $id("upCancel").addEventListener("click", ()=>{
      link.value=title.value=cover.value=desc.value=""; updatePrev(); err.textContent=""; 
    });

    $id("upSubmit").addEventListener("click", async ()=>{
      err.textContent="";
      const L = (link.value||"").trim();
      if (!L){ err.textContent="Adj meg egy linket."; return; }
      const payload = {
        link: L,
        title: (title.value||"").trim() || "Cím nélkül",
        cover: (cover.value||"").trim() || "",
        content: (desc.value||"").trim() || "",
        createdAt: window.fb.db.serverTimestamp()
      };
      try{
        const { db, collection, addDoc } = window.fb.db;
        await addDoc(collection(db,"categories",catKey,"movies"), payload);
        link.value=title.value=cover.value=desc.value="";
        updatePrev();
        if (typeof afterAdded==="function") afterAdded();
      }catch(e){ err.textContent = e?.message || "Feltöltési hiba."; }
    });
  }

  // ---- Lista betöltés
  let unsub = null;
  function detach(){
    if (typeof unsub === "function"){ try{unsub();}catch{} }
    unsub = null;
  }

  async function loadCategory(catKey, label){
    detach();
    $("#catBar").style.display = "none";

    const admin = isAdmin();
    const uploader = admin ? uploaderHtml(catKey) : "";
    $("#view").innerHTML = `
      ${uploader}
      <div class="card" style="margin:12px;">
        <button class="btn btn-danger btn-back" id="btnBackHome">Vissza a főoldalra</button>
        <h2 style="margin:4px 0 8px">${label}</h2>
        <div class="muted" id="listInfo" style="margin-bottom:10px">Lista betöltése…</div>
        <div id="list-${catKey}" class="grid"></div>
      </div>`;

    $("#btnBackHome").addEventListener("click",()=>{ detach(); goHome(); });

    if (admin){ bindUploader(catKey); }

    const host = document.getElementById(`list-${catKey}`);
    if (!window.fb?.db){ host.innerHTML = `<div class="muted">Firebase nincs inicializálva.</div>`; return; }

    const { db, collection, getDocs, onSnapshot, query, orderBy, limit, doc, deleteDoc } = window.fb.db;
    try{
      const q = query(collection(db,"categories",catKey,"movies"), orderBy("createdAt","desc"), limit(200));

      const render = (movies)=>{
        if (!movies.length){
          host.innerHTML = `<div class="muted">Még nincs film ebben a kategóriában.</div>`;
          updateBadges(catKey, 0);
          return;
        }
        host.innerHTML = movies.map(m=>cardHtml(m,catKey,admin)).join("");
        updateBadges(catKey, movies.length);

        if (admin){
          host.querySelectorAll(".btn-del").forEach(btn=>{
            btn.addEventListener("click", async ()=>{
              const id = btn.dataset.id;
              if (!confirm("Biztosan törlöd ezt a filmet?")) return;
              try{
                await deleteDoc(doc(db,"categories",catKey,"movies",id));
              }catch(e){ alert("Törlési hiba: "+(e?.message||e)); }
            });
          });
        }
      };

      if (admin){
        unsub = onSnapshot(q, snap=>{
          const movies = snap.docs.map(d=>({ id:d.id, ...d.data() }));
          render(movies);
          const info = document.getElementById("listInfo"); if (info) info.textContent = "Valós idejű lista (admin mód)";
        }, err=>{
          host.innerHTML = `<div class="muted">Hiba (realtime): ${err?.message||err}</div>`;
        });
      } else {
        const snap = await getDocs(q);
        const movies = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        render(movies);
        const info = document.getElementById("listInfo"); if (info) info.textContent = "Egyszeri lista (vendég mód)";
      }
    }catch(e){
      host.innerHTML = `<div class="muted">Hiba: ${e?.message||e}</div>`;
    }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    const top = document.getElementById("topFilters");
    top.addEventListener("click",(e)=>{
      const b = e.target.closest(".chip"); if(!b) return;
      const g = b.dataset.goto;
      if (g==="krimi")    loadCategory("krimi","KRIMI");
      if (g==="akcio")    loadCategory("akcio","AKCIÓ");
      if (g==="thriller") loadCategory("thriller","THRILLER");
      if (g==="actors"){
        detach();
        document.getElementById("catBar").style.display="none";
        document.getElementById("view").innerHTML = `
          <div class="card" style="margin:12px;">
            <button class="btn btn-danger btn-back" id="btnBackHome">Vissza a főoldalra</button>
            <h2 style="margin:4px 0 8px">Színészek</h2>
            <div class="muted">20 név – hamarosan.</div>
          </div>`;
        document.getElementById("btnBackHome").addEventListener("click",()=>{ goHome(); });
      }
    });

    document.getElementById("btnRefreshAll").addEventListener("click", ()=>{
      const openList = document.querySelector('#view [id^="list-"]');
      if (!openList) return;
      const catKey = openList.id.replace(/^list-/,'');
      loadCategory(catKey, catKey.toUpperCase());
    });
  });

  document.addEventListener("admin:login", ()=>{
    const openList = document.querySelector('#view [id^="list-"]');
    if (!openList) return;
    const catKey = openList.id.replace(/^list-/,'');
    loadCategory(catKey, catKey.toUpperCase());
  });
  document.addEventListener("admin:logout", ()=>{
    const openList = document.querySelector('#view [id^="list-"]');
    if (!openList) return;
    const catKey = openList.id.replace(/^list-/,'');
    loadCategory(catKey, catKey.toUpperCase());
  });
})();
</script>
<!-- ========== 7. RÉSZ VÉGE – FILMLISTA + ADMIN FELTÖLTŐ + TÖRLÉS ========== -->

<!-- ========== 8. RÉSZ ELEJE – FAVICON ========== -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text y='50%' x='50%' dominant-baseline='middle' text-anchor='middle' font-size='44'>🎬</text></svg>">
<!-- ========== 8. RÉSZ VÉGE – FAVICON ========== -->

</body>
</html>
