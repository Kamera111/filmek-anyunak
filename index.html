<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Filmek Anyunak</title>

  <!-- =========================
       1. RÉSZ ELEJE – ALAP STÍLUSOK
  ========================== -->
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --txt:#e5e7eb; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .sticky{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(15,23,42,.98),rgba(15,23,42,.7) 60%,rgba(15,23,42,0));backdrop-filter:blur(6px)}
    header{display:flex;align-items:center;gap:12px;padding:10px 0}
    .title{font-weight:800;font-size:clamp(20px,4.6vw,28px)}
    .btn{background:#1f2937;color:#fff;border:1px solid #334155;border-radius:12px;padding:9px 13px;cursor:pointer;font-weight:600}
    .btn:active{transform:scale(.98)}
    .btn-danger{background:#dc2626;border-color:#b91c1c}
    .muted{color:var(--muted);font-size:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px}
    a{color:#a5f3fc;text-decoration:none} a:hover{text-decoration:underline}
    img{max-width:100%;border-radius:10px;border:1px solid #1f2937}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}

    /* felső színes kategória gombok */
    .top-filters{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;padding:6px 12px 12px}
    @media (max-width:900px){.top-filters{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.top-filters{grid-template-columns:1fr}}
    .chip{display:flex;flex-direction:column;gap:4px;padding:12px 14px;border-radius:14px;color:#fff;border:1px solid rgba(255,255,255,.16);box-shadow:0 4px 14px rgba(0,0,0,.18);cursor:pointer;transition:.12s}
    .chip:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.22);filter:brightness(1.03)}
    .chip-title{font-weight:800}
    .chip-sub{font-size:14px;opacity:.95}
    .chip-krimi{background:linear-gradient(180deg,#16a34a,#15803d)}
    .chip-akcio{background:linear-gradient(180deg,#2563eb,#1e40af)}
    .chip-thriller{background:linear-gradient(180deg,#e11d48,#be123c)}
    .chip-actors{background:linear-gradient(180deg,#f59e0b,#b45309)}

    /* ÉLŐ kártyarács (főoldali linkek) */
    #catBar{padding:12px}
    .cats-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .cat{display:flex;flex-direction:column;gap:6px;padding:14px 16px;border-radius:14px;background:#1f2937;color:#fff;border:1px solid #0f2437;box-shadow:0 4px 14px rgba(0,0,0,.18)}
    .cat .name{color:#22c55e;font-weight:700;font-size:18px}
    .cat .name .live{color:#ef4444;font-weight:900;margin-right:4px}
    .cat .now{font-size:15px}

    /* Színész rács + fejléc */
    .actor-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .actor{background:#1f2937;border:1px solid #0f2437;border-radius:14px;padding:10px;cursor:pointer}
    .actor img{width:100%;height:220px;object-fit:cover;border-radius:12px}
    .actor .name{font-weight:800;margin:8px 0 4px}
    .actor .sub{color:#94a3b8;font-size:13px}
    .actor-header{display:flex;gap:12px;align-items:center}
    .actor-header img{width:92px;height:92px;object-fit:cover;border-radius:12px}

    /* Okos kereső modal */
    .modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:1010}
    .modal{width:min(680px,95vw);background:#0b1220;border:1px solid #334155;border-radius:14px;padding:18px}
    .m-title{font-weight:800;margin:0 0 6px}
    .m-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}

    /* Vendég kapu */
    .gate-mask{position:fixed;inset:0;background:rgba(15,23,42,.96);z-index:9999;display:none;align-items:center;justify-content:center}
    .gate-locked, .gate-locked body{overflow:hidden}
    .gate{width:min(560px,92vw);background:#0b1220;border:1px solid #334155;border-radius:14px;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.55)}
    .gate h3{margin:0 0 10px;font-size:20px}
    .gate label{display:block;margin:8px 0 6px;color:#94a3b8}
    .gate input{width:100%;padding:14px 16px;border-radius:12px;border:1px solid #334155;background:#111827;color:#fff;font-size:18px;outline:none}
    .gate .hint{color:#94a3b8;font-size:14px;margin-top:6px}
    .gate .err{color:#f87171;font-size:14px;margin-top:8px;display:none}
  </style>
  <!-- =========================
       1. RÉSZ VÉGE – ALAP STÍLUSOK
  ========================== -->

  <!-- =========================
       2. RÉSZ ELEJE – FIREBASE INIT + API KULCS HELY
  ========================== -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, onSnapshot,
      query, orderBy, limit, serverTimestamp, doc, deleteDoc,
      getCountFromServer
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBDSI-z3a4IFAIoKCVZVcUyue7GMoO5acY",
      authDomain: "filmek-fe035.firebaseapp.com",
      projectId: "filmek-fe035",
      storageBucket: "filmek-fe035.appspot.com",
      messagingSenderId: "302167835367",
      appId: "1:302167835367:web:6e0fd4304c4496612c1842",
      measurementId: "G-QBG7LG0ZQH"
    };

    const app  = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);

    // globális horgok
    window.firebaseConfig = firebaseConfig;
    window.fb = Object.freeze({
      app,
      db: { db, collection, addDoc, getDocs, onSnapshot, query, orderBy, limit, serverTimestamp, doc, deleteDoc, getCountFromServer },
      auth: { auth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
    });

    // --- 2.1: Film-tartalomhoz külső API kulcsok helye (opcionális) ---
    window.MOVIE_API = {
      TMDB_API_KEY: "",  // ha kitöltöd, megpróbál rövid leírást húzni TMDb-ről
      OMDB_API_KEY: ""   // alternatíva: OMDb kulcs
    };

    console.debug("[Firebase] READY – project:", firebaseConfig.projectId);
  </script>
  <!-- =========================
       2. RÉSZ VÉGE – FIREBASE INIT + API KULCS HELY
  ========================== -->
</head>

<body>
<!-- =========================
     3. RÉSZ ELEJE – UI: FEJLÉC + TOP KATEGÓRIÁK + FŐ NÉZET
========================== -->
<div id="guestGate" class="gate-mask" aria-modal="true" role="dialog">
  <div class="gate">
    <h3>Vendég kapu</h3>
    <label for="pinIn">PIN (6 számjegy)</label>
    <input id="pinIn" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Kattints! Ide írd a kódot">
    <div class="hint">Írd be a kódot – a nézet automatikusan megnyílik.</div>
    <div id="pinErr" class="err">Hibás PIN.</div>
  </div>
</div>

<div id="smartModal" class="modal-mask">
  <div class="modal">
    <div class="m-title">Okos kereső</div>
    <div class="muted">Gyors linkek előre kitöltött keresésekkel (Videa / YouTube / Indavideo / Google site:)</div>
    <div id="smartLinks" class="m-row"></div>
    <div style="margin-top:12px"><button id="smartClose" class="btn btn-danger">Bezár</button></div>
  </div>
</div>

<div id="app" class="wrap">
  <div class="sticky">
    <header>
      <div class="title">Filmek Anyunak</div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="btnLogoutAll" class="btn btn-danger" title="Kijelentkezés és vissza">Kilépés mindenből</button>
        <button id="btnRefreshAll" class="btn">Frissítés</button>
      </div>
    </header>

    <div id="topFilters" class="top-filters">
      <button class="chip chip-krimi"    data-goto="krimi"><div class="chip-title">KRIMI</div><div class="chip-sub">Új:<span id="badge-new-krimi">0</span> · Összes:<span id="badge-all-krimi">0</span></div></button>
      <button class="chip chip-akcio"    data-goto="akcio"><div class="chip-title">AKCIÓ</div><div class="chip-sub">Új:<span id="badge-new-akcio">0</span> · Összes:<span id="badge-all-akcio">0</span></div></button>
      <button class="chip chip-thriller" data-goto="thriller"><div class="chip-title">THRILLER</div><div class="chip-sub">Új:<span id="badge-new-thriller">0</span> · Összes:<span id="badge-all-thriller">0</span></div></button>
      <button class="chip chip-actors"   data-goto="actors"><div class="chip-title">SZÍNÉSZEK</div><div class="chip-sub">Galéria és filmek</div></button>
    </div>

    <div id="catBar"><div class="cats-row" id="catsLive"></div></div>
  </div>

  <main id="view" class="view"></main>
</div>
<!-- =========================
     3. RÉSZ VÉGE – UI
========================== -->

<!-- =========================
     3.1 RÉSZ ELEJE – KILÉPÉS mindenből (localStorage + Firebase signOut)
========================== -->
<script>
(function(){
  async function doLogout(){
    try{
      localStorage.removeItem("filmek_anyunak_guest_ok");
      localStorage.removeItem("filmek_anyunak_admin_ok");
      localStorage.removeItem("admin_email");
      sessionStorage.clear();
    }catch{}
    try{
      const a = window.fb?.auth?.auth;
      const so = window.fb?.auth?.signOut;
      if (a && typeof so === "function"){
        await Promise.race([ so(a), new Promise(r=>setTimeout(r,1200)) ]);
      }
    }catch{}
    const clean = location.origin + location.pathname;
    if (location.href !== clean) location.href = clean; else location.reload();
  }
  document.addEventListener("click",(e)=>{
    const b = e.target.closest("#btnLogoutAll,button");
    if (!b) return;
    const t = (b.textContent||"") + " " + (b.title||"") + " " + (b.getAttribute?.("aria-label")||"");
    if (!/(kilép|kijelent|logout|sign\s*out)/i.test(t)) return;
    e.preventDefault(); e.stopPropagation();
    doLogout();
  }, true);
})();
</script>
<!-- =========================
     3.1 RÉSZ VÉGE
========================== -->

<!-- =========================
     5. RÉSZ ELEJE – „ÉLŐ” gombok (csak linkek)
========================== -->
<script>
(function(){
  const list = [
    {name:"ÉLŐ Vígjáték TV", url:"https://sweet.tv/hu/free_tv/2014-comedy-universe-hd", provider:"sweet"},
    {name:"ÉLŐ Akció TV",    url:"https://sweet.tv/hu/free_tv/2010-action-zone-hd",     provider:"sweet"},
    {name:"ÉLŐ Thriller TV", url:"https://sweet.tv/hu/free_tv/2016-thriller-time-hd",    provider:"sweet"},
    {name:"ÉLŐ TOP Filmek",  url:"https://sweet.tv/hu/free_tv/2967-top-movies-hd",       provider:"sweet"},
    {name:"Mozi+ tv",      url:"https://player.telekomtvgo.hu/player/live?channelNumber=13"},
    {name:"Film + tv",     url:"https://player.telekomtvgo.hu/player/live?channelNumber=15"},
    {name:"Prime tv",      url:"https://player.telekomtvgo.hu/player/live?channelNumber=21"},
    {name:"RTL 2 tv",      url:"https://player.telekomtvgo.hu/player/live?channelNumber=24"},
    {name:"FilmCafe tv",   url:"https://player.telekomtvgo.hu/player/live?channelNumber=28"},
    {name:"ozone tv",      url:"https://player.telekomtvgo.hu/player/live?channelNumber=30"},
    {name:"Cool tv",       url:"https://player.telekomtvgo.hu/player/live?channelNumber=60"},
    {name:"AXN tv",        url:"https://player.telekomtvgo.hu/player/live?channelNumber=61"},
    {name:"AMC tv",        url:"https://player.telekomtvgo.hu/player/live?channelNumber=62"},
    {name:"Paramount tv",  url:"https://player.telekomtvgo.hu/player/live?channelNumber=66"},
    {name:"FilmMánia tv",  url:"https://player.telekomtvgo.hu/player/live?channelNumber=163"},
    {name:"Moziverzum tv", url:"https://player.telekomtvgo.hu/player/live?channelNumber=169"}
  ];
  const host = document.getElementById("catsLive");
  if (!host) return;
  for (const ch of list){
    const a = document.createElement("a");
    a.className="cat"; a.target="_blank"; a.rel="noopener"; a.href=ch.url;
    const safe = ch.name.replace(/^ÉLŐ(\s+)/, "<span class='live'>ÉLŐ</span>$1");
    a.innerHTML = `<div class="name">${safe}</div><div class="now"><span class="label">Most megy:</span> <span class="title">Kattints</span></div>`;
    host.appendChild(a);
  }
})();
</script>
<!-- =========================
     5. RÉSZ VÉGE
========================== -->

<!-- =========================
     7. RÉSZ ELEJE – KATEGÓRIÁK, SZÍNÉSZEK, FELTÖLTŐ, PIN-KAPU, OKOS KERESŐ
========================== -->
<script>
(function(){
  const $ = (s,r=document)=>r.querySelector(s);

  /* ------ admin állapot ------ */
  const LS_ADMIN_OK = "filmek_anyunak_admin_ok";
  const isAdmin = ()=> {
    try{
      if (window.fb?.auth?.auth?.currentUser) return true;
      return localStorage.getItem(LS_ADMIN_OK)==="1";
    }catch{ return false; }
  };

  const catLabel = (k)=>({krimi:"KRIMI", akcio:"AKCIÓ", thriller:"THRILLER"})[k]||k.toUpperCase();

  /* ------ színészek (távoli képekkel, hogy biztos látszódjanak) ------ */
  const ACTORS_RAW = [
    {name:"Sylvester Stallone",      photo:"https://upload.wikimedia.org/wikipedia/commons/3/39/Sylvester_Stallone_2019_%28cropped%29.jpg"},
    {name:"Jason Statham",           photo:"https://upload.wikimedia.org/wikipedia/commons/3/39/Jason_Statham_2018.jpg"},
    {name:"Jet Li",                  photo:"https://upload.wikimedia.org/wikipedia/commons/5/5c/Jet_Li_2009.jpg"},
    {name:"Dolph Lundgren",          photo:"https://upload.wikimedia.org/wikipedia/commons/2/2e/Dolph_Lundgren_2018.jpg"},
    {name:"Randy Couture",           photo:"https://upload.wikimedia.org/wikipedia/commons/1/1d/Randy_Couture_2008.jpg"},
    {name:"Terry Crews",             photo:"https://upload.wikimedia.org/wikipedia/commons/d/df/Terry_Crews_2019.jpg"},
    {name:"Mickey Rourke",           photo:"https://upload.wikimedia.org/wikipedia/commons/7/71/Mickey_Rourke_2009.jpg"},
    {name:"Eric Roberts",            photo:"https://upload.wikimedia.org/wikipedia/commons/4/47/Eric_Roberts_2013.jpg"},
    {name:"Bruce Willis",            photo:"https://upload.wikimedia.org/wikipedia/commons/8/89/Bruce_Willis_by_Gage_Skidmore.jpg"},
    {name:"Arnold Schwarzenegger",   photo:"https://upload.wikimedia.org/wikipedia/commons/9/98/Arnold_Schwarzenegger_2019.jpg"},
    {name:"Wesley Snipes",           photo:"https://upload.wikimedia.org/wikipedia/commons/4/47/Wesley_Snipes_2014.jpg"},
    {name:"Antonio Banderas",        photo:"https://upload.wikimedia.org/wikipedia/commons/0/0f/Antonio_Banderas_2019.jpg"},
    {name:"Mel Gibson",              photo:"https://upload.wikimedia.org/wikipedia/commons/7/7d/Mel_Gibson_Cannes_2016.jpg"},
    {name:"Lucy Liu",                photo:"https://upload.wikimedia.org/wikipedia/commons/3/3d/Lucy_Liu_2012.jpg"},
    {name:"Andy Garcia",             photo:"https://upload.wikimedia.org/wikipedia/commons/9/9e/Andy_Garcia_2009.jpg"},
    {name:"Jean-Claude Van Damme",   photo:"https://upload.wikimedia.org/wikipedia/commons/8/80/Jean-Claude_Van_Damme_2012.jpg"},
    {name:"Kelsey Grammer",          photo:"https://upload.wikimedia.org/wikipedia/commons/0/0c/Kelsey_Grammer_2010.jpg"},
    {name:"Kellan Lutz",             photo:"https://upload.wikimedia.org/wikipedia/commons/7/74/Kellan_Lutz_2012.jpg"},
    {name:"Ronda Rousey",            photo:"https://upload.wikimedia.org/wikipedia/commons/5/5d/Ronda_Rousey_2018.jpg"},
    {name:"Glen Powell",             photo:"https://upload.wikimedia.org/wikipedia/commons/2/22/Glen_Powell_2019.jpg"},
    {name:"Victor Ortiz",            photo:"https://upload.wikimedia.org/wikipedia/commons/6/6a/Victor_Ortiz_2011.jpg"},
    {name:"Harrison Ford",           photo:"https://upload.wikimedia.org/wikipedia/commons/9/9f/Harrison_Ford_2017.jpg"},
    {name:'Curtis "50 Cent" Jackson',photo:"https://upload.wikimedia.org/wikipedia/commons/b/b0/50_Cent_2018.jpg"},
    {name:"Megan Fox",               photo:"https://upload.wikimedia.org/wikipedia/commons/5/50/Megan_Fox_2009.jpg"},
    {name:"Tony Jaa",                photo:"https://upload.wikimedia.org/wikipedia/commons/3/38/Tony_Jaa_2018.jpg"},
    {name:"Jacob Scipio",            photo:"https://upload.wikimedia.org/wikipedia/commons/0/0c/Jacob_Scipio_2020.jpg"},
    {name:"Levy Tran",               photo:"https://upload.wikimedia.org/wikipedia/commons/8/8e/Levy_Tran_2019.jpg"},
    {name:"Iko Uwais",               photo:"https://upload.wikimedia.org/wikipedia/commons/1/1c/Iko_Uwais_2012.jpg"},
    {name:"Chuck Norris",            photo:"https://upload.wikimedia.org/wikipedia/commons/3/35/Chuck_Norris_May_2015.jpg"}
  ];
  const ACTORS = ACTORS_RAW.map(a=>({ ...a, id: slug(a.name) }));

  /* --- Expendables 2 statikus link az érintettekhez --- */
  const EX2_URL = "https://videa.hu/videok/film-animacio/a-felaldozhatok-2-2012-DYijjZfk6FlRP35xe";
  const EX2_ACTORS = [
    "sylvester-stallone","jason-statham","jet-li","dolph-lundgren",
    "randy-couture","terry-crews","bruce-willis","arnold-schwarzenegger",
    "jean-claude-van-damme","chuck-norris"
  ];

  function slug(s){ return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""); }
  function findActor(id){ return ACTORS.find(a=>a.id===id); }

  const IMG_FALLBACK = "data:image/svg+xml;utf8," + encodeURIComponent(
    `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 80'>
       <rect width='120' height='80' rx='12' fill='#1f2937'/>
       <circle cx='40' cy='32' r='14' fill='#4b5563'/>
       <rect x='20' y='50' width='80' height='18' rx='9' fill='#4b5563'/>
     </svg>`);

  function updateBadges(catKey, total){
    const t = document.getElementById(`badge-all-${catKey}`); if (t) t.textContent=String(total||0);
    const n = document.getElementById(`badge-new-${catKey}`); if (n) n.textContent="0";
  }

  /* --- oEmbed meta + automata leírás --- */
  async function fetchMeta(url){
    const u = String(url||"").trim();
    if (!u) return {};
    const get = async ep=>{ const r=await fetch(ep,{mode:"cors"}); if(!r.ok) throw 0; return r.json(); };
    try{
      if (/youtube\.com|youtu\.be/.test(u)){ const o=await get(`https://www.youtube.com/oembed?url=${encodeURIComponent(u)}&format=json`); return {title:o.title,cover:o.thumbnail_url}; }
      if (/vimeo\.com/.test(u)){ const o=await get(`https://vimeo.com/api/oembed.json?url=${encodeURIComponent(u)}`); return {title:o.title,cover:o.thumbnail_url}; }
      if (/dailymotion\.com/.test(u)){ const o=await get(`https://www.dailymotion.com/services/oembed?url=${encodeURIComponent(u)}`); return {title:o.title,cover:o.thumbnail_url}; }
    }catch(e){}
    try{
      const p=new URL(u);
      const last=decodeURIComponent(p.pathname.split("/").filter(Boolean).pop()||"");
      const guess=last.replace(/[-_]/g," ").replace(/\.\w+$/,"");
      return {title:guess||p.hostname, cover:""};
    }catch{ return {}; }
  }
  async function fetchPlotByTitle(title){
    const t = (title||"").trim(); if (!t) return "";
    try{
      if (window.MOVIE_API?.TMDB_API_KEY){
        const k = window.MOVIE_API.TMDB_API_KEY;
        const q = encodeURIComponent(t);
        const r = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${k}&language=hu-HU&query=${q}`); const j=await r.json();
        const m = j?.results?.[0]; if (m?.overview) return m.overview;
      }
      if (window.MOVIE_API?.OMDB_API_KEY){
        const k = window.MOVIE_API.OMDB_API_KEY;
        const r = await fetch(`https://www.omdbapi.com/?t=${encodeURIComponent(t)}&plot=short&apikey=${k}`); const j=await r.json();
        if (j?.Plot && j.Plot !== "N/A") return j.Plot;
      }
    }catch(e){}
    return "";
  }

  /* --- filmkártya --- */
  function cardHtml(m, admin, delMeta){
    const img = m.cover ? `<img src="${m.cover}" alt="">` : "";
    const title = m.title || "Cím nélkül";
    const content = m.content || "";
    const link = m.link || "#";
    const delBtn = (admin && delMeta && delMeta.id)
      ? `<button class="btn btn-danger btn-del" data-id="${delMeta.id}" data-path="${(delMeta.path||[]).join("/")}">Törlés</button>`
      : "";
    return `<div class="card">${img}
      <div style="font-weight:800;margin:6px 0">${title}</div>
      <div class="muted" style="margin-bottom:8px">${content}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn" href="${link}" target="_blank" rel="noopener">Megnyitás</a>${delBtn}
      </div></div>`;
  }

  /* --- feltöltő UI + bind --- */
  function uploaderHtml(scopeLabel){
    return `
      <div class="card" style="margin:12px;">
        <h3 style="margin:0 0 8px">Új film hozzáadása – <span class="muted">${scopeLabel}</span></h3>
        <div class="uploader">
          <div class="field"><label>Videó/film link</label><input id="upLink" type="url" placeholder="Illeszd be a linket (pl. YouTube, Videa…)"><div class="hint">Beillesztés után a cím és borítókép automatikus (ha elérhető).</div></div>
          <div class="two" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="field"><label>Cím</label><input id="upTitle" type="text" placeholder="Automatikus, de módosítható"></div>
            <div class="field"><label>Borítókép (URL)</label><input id="upCover" type="url" placeholder="Automatikus, ha van oEmbed"></div>
          </div>
          <div class="field"><label>Leírás (opcionális)</label><input id="upDesc" type="text" placeholder="Rövid megjegyzés…"></div>
          <div class="preview" style="margin:6px 0"><img id="upPrev" src="" alt="" style="display:none;max-width:320px;border-radius:10px;border:1px solid #1f2937"></div>
          <div class="row" style="display:flex;gap:8px"><button id="upCancel" class="btn btn-danger" type="button">Mégse</button><button id="upSubmit" class="btn" type="button">Feltöltés</button></div>
          <div class="err" id="upErr" style="color:#f87171;margin-top:6px"></div>
        </div>
      </div>`;
  }
  function bindUploader(targetPathBuilder, afterAdded){
    const $id=(x)=>document.getElementById(x);
    const link=$id("upLink"), title=$id("upTitle"), cover=$id("upCover"), desc=$id("upDesc"), prev=$id("upPrev"), err=$id("upErr");
    const updatePrev=()=>{ const u=(cover.value||"").trim(); prev.style.display=u?"block":"none"; prev.src=u||""; };
    cover.addEventListener("input", updatePrev);
    let t1=null,t2=null;

    link.addEventListener("input", ()=>{
      clearTimeout(t1);
      t1=setTimeout(async ()=>{
        err.textContent="";
        const meta = await fetchMeta(link.value);
        if (meta.title && !title.value) title.value = meta.title;
        if (meta.cover && !cover.value){ cover.value = meta.cover; updatePrev(); }
        if (!desc.value && title.value){
          const plot = await fetchPlotByTitle(title.value);
          if (plot) desc.value = plot;
        }
      }, 300);
    });
    title.addEventListener("input", ()=>{
      clearTimeout(t2);
      t2=setTimeout(async ()=>{
        if (!desc.value && title.value){
          const plot = await fetchPlotByTitle(title.value);
          if (plot) desc.value = plot;
        }
      }, 500);
    });

    $id("upCancel").addEventListener("click", ()=>{ link.value=title.value=cover.value=desc.value=""; updatePrev(); err.textContent=""; });

    $id("upSubmit").addEventListener("click", async ()=>{
      err.textContent="";
      const L=(link.value||"").trim(); if(!L){ err.textContent="Adj meg egy linket."; return; }
      const payload={ link:L, title:(title.value||"").trim()||"Cím nélkül", cover:(cover.value||"").trim()||"", content:(desc.value||"").trim()||"", createdAt: window.fb.db.serverTimestamp() };
      try{
        const { db, collection, addDoc } = window.fb.db;
        const { root, segments } = targetPathBuilder();
        await addDoc(collection(db, ...root, ...segments), payload);
        document.dispatchEvent(new Event("badges:refresh"));
        link.value = title.value = cover.value = desc.value = ""; updatePrev();
        if (typeof afterAdded==="function") afterAdded();
      }catch(e){ err.textContent = e?.message || "Feltöltési hiba."; }
    });
  }

  /* --- nézetkezelés --- */
  let unsub=null; const detach=()=>{ if(typeof unsub==="function"){try{unsub();}catch{}} unsub=null; };
  function goHome(){ $("#catBar").style.display=""; const v=$("#view"); v.dataset.type=""; v.dataset.key=""; v.innerHTML=""; window.scrollTo({top:0,behavior:"smooth"}); }

  async function loadCategory(catKey,label){
    detach(); $("#catBar").style.display="none";
    const admin=isAdmin(); const uploader=admin?uploaderHtml(catLabel(catKey)):"";
    const v=$("#view"); v.dataset.type="category"; v.dataset.key=catKey;
    v.innerHTML = `${uploader}
      <div class="card" style="margin:12px;">
        <button class="btn btn-danger btn-back" id="btnBackHome">Vissza a főoldalra</button>
        <h2 style="margin:4px 0 8px">${label}</h2>
        <div class="muted" id="listInfo" style="margin-bottom:10px">Lista betöltése…</div>
        <div id="list-${catKey}" class="grid"></div>
      </div>`;
    $("#btnBackHome").addEventListener("click", ()=>{ detach(); goHome(); });
    if (admin) bindUploader(()=>({root:["categories",catKey],segments:["movies"]}));

    const host=document.getElementById(`list-${catKey}`);
    const {db,collection,getDocs,onSnapshot,query,orderBy,limit,doc,deleteDoc} = window.fb.db;

    try{
      const q = query(collection(db,"categories",catKey,"movies"), orderBy("createdAt","desc"), limit(200));
      const render=(movies)=>{
        if(!movies.length){ host.innerHTML=`<div class="muted">Még nincs film ebben a kategóriában.</div>`; updateBadges(catKey,0); return; }
        host.innerHTML = movies.map(m=>cardHtml(m, admin, {id:m.id, path:["categories",catKey,"movies"]})).join("");
        updateBadges(catKey,movies.length);
        if(admin){
          host.querySelectorAll(".btn-del").forEach(b=>{
            b.addEventListener("click", async ()=>{
              const id=b.dataset.id; if(!confirm("Biztosan törlöd ezt a filmet?")) return;
              try{ await deleteDoc(doc(db,"categories",catKey,"movies",id)); document.dispatchEvent(new Event("badges:refresh")); }
              catch(e){ alert("Törlési hiba: "+(e?.message||e)); }
            });
          });
        }
      };
      if(admin){
        unsub = onSnapshot(q, snap=>{
          render(snap.docs.map(d=>({id:d.id,...d.data()})));
          const info=$("#listInfo"); if(info) info.textContent="Valós idejű lista (admin mód)";
        }, err=>{ host.innerHTML=`<div class="muted">Hiba (realtime): ${err?.message||err}</div>`; });
      }else{
        const snap = await getDocs(q);
        render(snap.docs.map(d=>({id:d.id,...d.data()})));
        const info=$("#listInfo"); if(info) info.textContent="Egyszeri lista (vendég mód)";
      }
    }catch(e){ host.innerHTML=`<div class="muted">Hiba: ${e?.message||e}</div>`; }
  }

  function renderActorsGallery(){
    detach(); $("#catBar").style.display="none";
    const v=$("#view"); v.dataset.type="actors"; v.dataset.key=""; 
    v.innerHTML = `<div class="card" style="margin:12px;">
      <button class="btn btn-danger btn-back" id="btnBackHome">Vissza a főoldalra</button>
      <h2 style="margin:4px 0 8px">Színészek</h2>
      <div class="actor-grid" id="actorGrid"></div>
    </div>`;
    $("#btnBackHome").addEventListener("click", goHome);

    const grid=$("#actorGrid");
    grid.innerHTML = ACTORS.map(a=>`
      <div class="actor" data-id="${a.id}">
        <img src="${a.photo}" alt="${a.name}" referrerpolicy="no-referrer"
             onerror="this.onerror=null;this.src='${IMG_FALLBACK}'">
        <div class="name">${a.name}</div>
        <div class="sub"><span class="actor-count" data-id="${a.id}">számolás…</span> · kattints</div>
      </div>`).join("");

    grid.querySelectorAll(".actor").forEach(el=>{
      el.addEventListener("click", ()=> loadActorDetails(el.dataset.id));
    });

    refreshActorCounts();
  }

  async function refreshActorCounts(){
    try{
      const { db, collection, getCountFromServer } = window.fb.db;
      const els = document.querySelectorAll(".actor-count");
      for (const el of els){
        const id = el.dataset.id;
        try{
          const coll = collection(db, "actors", id, "movies");
          const snap = await getCountFromServer(coll);
          const c = snap.data().count || 0;
          el.textContent = c===1 ? "1 film" : `${c} film`;
        }catch{ el.textContent = "0 film"; }
      }
    }catch(e){}
  }

  function openSmartSearch(actorName){
    const m = document.getElementById("smartModal");
    const box = document.getElementById("smartLinks");
    const q = encodeURIComponent(`${actorName} teljes film magyarul`);
    const set = [
      {label:"Videa", url:`https://videa.hu/kereses/${q}`},
      {label:"YouTube", url:`https://www.youtube.com/results?search_query=${q}`},
      {label:"Indavideo", url:`https://indavideo.hu/tag/kereses?search=${q}`},
      {label:"Google (site:videa.hu)", url:`https://www.google.com/search?q=site%3Avidea.hu+${q}`},
      {label:"Google (site:indavideo.hu)", url:`https://www.google.com/search?q=site%3Aindavideo.hu+${q}`},
      {label:"Google (általános)", url:`https://www.google.com/search?q=${q}`},
      {label:"jobbmintatv (Google)", url:`https://www.google.com/search?q=site%3Ajobbmintatv.hu+${q}`}
    ];
    box.innerHTML = set.map(s=>`<a class="btn" target="_blank" rel="noopener" href="${s.url}">${s.label}</a>`).join("");
    m.style.display="flex";
  }

  async function loadActorDetails(actorId){
    const actor = findActor(actorId); if(!actor){ alert("Ismeretlen színész."); return; }
    detach(); $("#catBar").style.display="none";
    const admin=isAdmin(); const uploader=admin?uploaderHtml(actor.name):"";
    const v=$("#view"); v.dataset.type="actor"; v.dataset.key=actorId;
    v.innerHTML = `${uploader}
      <div class="card" style="margin:12px;">
        <div class="actor-header">
          <img src="${actor.photo}" alt="${actor.name}" referrerpolicy="no-referrer"
               onerror="this.onerror=null;this.src='${IMG_FALLBACK}'">
          <div class="who">
            <div style="font-weight:800;font-size:20px">${actor.name}</div>
            <div class="muted">Saját filmek</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin:12px 0;flex-wrap:wrap">
          <button class="btn btn-danger btn-back" id="btnBackActors">Vissza a színészekhez</button>
          <button class="btn" id="btnBackHome2">Főoldal</button>
          <button class="btn" id="btnSmart">Okos kereső (AI)</button>
        </div>
        <div class="muted" id="listInfo" style="margin-bottom:10px">Lista betöltése…</div>
        <div id="list-actor-${actorId}" class="grid"></div>
      </div>`;
    $("#btnBackActors").addEventListener("click", renderActorsGallery);
    $("#btnBackHome2").addEventListener("click", goHome);
    $("#btnSmart").addEventListener("click", ()=>openSmartSearch(actor.name));
    document.getElementById("smartClose").onclick = ()=>{ document.getElementById("smartModal").style.display="none"; };

    if (admin) bindUploader(()=>({root:["actors",actorId], segments:["movies"]}));

    const host=document.getElementById(`list-actor-${actorId}`);
    const {db,collection,getDocs,onSnapshot,query,orderBy,limit,doc,deleteDoc} = window.fb.db;

    try{
      const q = query(collection(db,"actors",actorId,"movies"), orderBy("createdAt","desc"), limit(200));
      const render=(movies)=>{
        if (EX2_ACTORS.includes(actorId)) {
          movies = [{id:null,title:"A feláldozhatók 2 (2012)",link:EX2_URL,cover:"",content:""}, ...movies];
        }
        if(!movies.length){ host.innerHTML=`<div class="muted">Még nincs film feltöltve.</div>`; return; }
        host.innerHTML = movies.map(m=>{
          const delMeta = (m.id ? {id:m.id, path:["actors",actorId,"movies"]} : null);
          return cardHtml(m, admin, delMeta);
        }).join("");

        if(admin){
          host.querySelectorAll(".btn-del").forEach(b=>{
            b.addEventListener("click", async ()=>{
              const id=b.dataset.id; if(!confirm("Biztosan törlöd ezt a filmet?")) return;
              try{ await deleteDoc(doc(db,"actors",actorId,"movies",id)); document.dispatchEvent(new Event("badges:refresh")); }
              catch(e){ alert("Törlési hiba: "+(e?.message||e)); }
            });
          });
        }
      };
      if(admin){
        unsub = onSnapshot(q, snap=>{
          render(snap.docs.map(d=>({id:d.id,...d.data()})));
          const info=$("#listInfo"); if(info) info.textContent="Valós idejű lista (admin mód)";
        }, err=>{ host.innerHTML=`<div class="muted">Hiba (realtime): ${err?.message||err}</div>`; });
      }else{
        const snap = await getDocs(q);
        render(snap.docs.map(d=>({id:d.id,...d.data()})));
        const info=$("#listInfo"); if(info) info.textContent="Egyszeri lista (vendég mód)";
      }
    }catch(e){ host.innerHTML=`<div class="muted">Hiba: ${e?.message||e}</div>`; }
  }

  /* --- felül lévő gombok vezérlése + frissítés --- */
  document.addEventListener("DOMContentLoaded", ()=>{
    const top=document.getElementById("topFilters");
    top.addEventListener("click",(e)=>{
      const b=e.target.closest(".chip"); if(!b) return;
      const g=b.dataset.goto;
      if(g==="krimi")    loadCategory("krimi","KRIMI");
      if(g==="akcio")    loadCategory("akcio","AKCIÓ");
      if(g==="thriller") loadCategory("thriller","THRILLER");
      if(g==="actors")   renderActorsGallery();
    });
    document.getElementById("btnRefreshAll").addEventListener("click", ()=>{
      const v=document.getElementById("view");
      const type=v.dataset.type, key=v.dataset.key;
      if(type==="category" && key) loadCategory(key, catLabel(key));
      else if(type==="actor" && key) loadActorDetails(key);
      else if(type==="actors") renderActorsGallery();
    });
  });

  /* --- Vendég PIN kapu --- */
  (function pinGate(){
    const LS_KEY="filmek_anyunak_guest_ok"; const PIN="195400";
    function showGate(){ const m=document.getElementById("guestGate"); if(!m) return; m.style.display="flex"; document.documentElement.classList.add("gate-locked"); const i=document.getElementById("pinIn"); const e=document.getElementById("pinErr"); if(i){i.value="";i.focus();} if(e) e.style.display="none"; }
    function hideGate(){ const m=document.getElementById("guestGate"); if(!m) return; m.style.display="none"; document.documentElement.classList.remove("gate-locked"); }
    document.addEventListener("DOMContentLoaded", ()=>{
      const adminLogged = localStorage.getItem(LS_ADMIN_OK)==="1" || !!(window.fb?.auth?.auth?.currentUser);
      if (!adminLogged && localStorage.getItem(LS_KEY)!=="1") showGate();
      const i=document.getElementById("pinIn"), e=document.getElementById("pinErr");
      if(i){
        i.addEventListener("input", ()=>{
          i.value = i.value.replace(/\D+/g,"").slice(0,6);
          if (i.value.length===6){
            if (i.value===PIN){ localStorage.setItem(LS_KEY,"1"); hideGate(); if(e) e.style.display="none"; }
            else { if(e) e.style.display="block"; }
          } else { if(e) e.style.display="none"; }
        });
      }
    });
  })();

})();
</script>
<!-- =========================
     7. RÉSZ VÉGE
========================== -->
</body>
</html>
<!-- ========== 8. RÉSZ ELEJE – KRIMI: 10 YouTube link egyszeri feltöltése ========== -->
<script>
/* 8.1 – A feltöltendő filmek (KRIMI kategória) */
const KRIMI_SEED_YT = [
  { title:"A múlt árnyai – krimi/thriller (HU)",                link:"https://www.youtube.com/watch?v=MTPP0QJaCls" },
  { title:"Egy gyilkosság forgatókönyve – krimi (HU)",          link:"https://www.youtube.com/watch?v=4y2er7ywN0k" },
  { title:"Krimi a Sárga tónál (1990) – magyar szinkron",       link:"https://www.youtube.com/watch?v=Yct_AacWfZs" },
  { title:"Gyilkosság a hajón – klasszikus krimi (HU)",         link:"https://www.youtube.com/watch?v=KDbtguYZVfw" },
  { title:"Végzetes éjszaka (1988) – thriller/krimi (HU)",      link:"https://www.youtube.com/watch?v=ZR9ERGMgt0I" },
  { title:"Szó nélkül – amszterdami krimi (HU)",                link:"https://www.youtube.com/watch?v=kHXJpBxJqJQ" },
  { title:"Egy rossz lépés – krimi (HU)",                       link:"https://www.youtube.com/watch?v=ayS2MjHmdBE" },
  { title:"Igazságtevő (1982) – akció-krimi (HU szinkron)",     link:"https://www.youtube.com/watch?v=_kMeJ8E67to" },
  { title:"A másik asszony (1950) – dráma/krimi (HU)",          link:"https://www.youtube.com/watch?v=ICZrmkgrA5s" },
  { title:"Tiltott (2017) – thriller/krimi (HU)",               link:"https://www.youtube.com/watch?v=RKRDqtalUH0" }
];

/* 8.2 – YouTube thumb (borítókép) */
function ytThumb(url){
  try{
    const u = new URL(url);
    const id = u.searchParams.get("v");
    return id ? `https://img.youtube.com/vi/${id}/hqdefault.jpg` : "";
  }catch{ return ""; }
}

/* 8.3 – Egyszeri KRIMI feltöltő (duplázás ellenőrzéssel) */
async function seedKrimiYoutube(force=false){
  const fbd = window.fb?.db;
  if(!fbd){ alert("Firebase nincs kész."); return; }
  const { db, collection, addDoc, getDocs, query, where, limit, serverTimestamp } = fbd;

  // opcionális „egyszer lefutott” jelölő (nem kötelező)
  if(localStorage.getItem("seed_krimi_yt_done") && !force){
    if(!confirm("Úgy tűnik, már futott ez a feltöltés. Újra próbálod?")) return;
  }

  const base = collection(db, "categories", "krimi", "movies");
  let added = 0, skipped = 0, errors = 0;

  for(const item of KRIMI_SEED_YT){
    try{
      // duplázás védelem: ugyanazzal a linkkel ne legyen több rekord
      const q = query(base, where("link","==",item.link), limit(1));
      const snap = await getDocs(q);
      if(!snap.empty){ skipped++; continue; }

      const payload = {
        title:   item.title,
        link:    item.link,
        cover:   ytThumb(item.link) || "",
        content: "",
        createdAt: serverTimestamp()
      };
      await addDoc(base, payload);
      added++;
    }catch(e){
      console.error("KRIMI seed hiba:", e);
      errors++;
    }
  }

  if(added>0) localStorage.setItem("seed_krimi_yt_done","1");
  alert(`KRIMI seed kész.\nÚj: ${added} · Kihagyva (dupla): ${skipped} · Hiba: ${errors}`);
}

/* 8.4 – Gomb betűzése a KRIMI nézetbe */
(function injectKrimiSeedButton(){
  const host = document.getElementById("view") || document.body;

  function place(){
    const listEl = document.getElementById("list-krimi");
    if(!listEl || document.getElementById("seedKrimiBox")) return;

    const box = document.createElement("div");
    box.id = "seedKrimiBox";
    box.className = "card";
    box.style.margin = "12px";
    box.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button class="btn" id="btnSeedKrimi">10 krimi link feltöltése (YouTube)</button>
        <span class="muted">Egyszeri művelet – duplázás ellenőrzéssel.</span>
      </div>`;
    listEl.parentElement?.insertBefore(box, listEl);

    const btn = document.getElementById("btnSeedKrimi");
    if(btn) btn.addEventListener("click", ()=>seedKrimiYoutube(false));
  }

  // Ha a KRIMI nézet már itt van, rakjuk ki azonnal:
  place();

  // Ha később érkezik meg, figyeljük a DOM-ot:
  const mo = new MutationObserver(()=>place());
  mo.observe(host, {childList:true, subtree:true});
})();
</script>
<!-- ========== 8. RÉSZ VÉGE – KRIMI: 10 YouTube link egyszeri feltöltése ========== -->

